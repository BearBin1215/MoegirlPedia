(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */e=function(){return r};var n,r={},o=Object.prototype,i=o.hasOwnProperty,a=Object.defineProperty||function(t,e,n){t[e]=n.value},l="function"==typeof Symbol?Symbol:{},c=l.iterator||"@@iterator",s=l.asyncIterator||"@@asyncIterator",u=l.toStringTag||"@@toStringTag";function d(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{d({},"")}catch(n){d=function(t,e,n){return t[e]=n}}function p(t,e,n,r){var o=e&&e.prototype instanceof w?e:w,i=Object.create(o.prototype),l=new P(r||[]);return a(i,"_invoke",{value:_(t,n,l)}),i}function b(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}r.wrap=p;var h="suspendedStart",f="suspendedYield",g="executing",m="completed",v={};function w(){}function y(){}function x(){}var k={};d(k,c,(function(){return this}));var $=Object.getPrototypeOf,O=$&&$($(T([])));O&&O!==o&&i.call(O,c)&&(k=O);var L=x.prototype=w.prototype=Object.create(k);function E(t){["next","throw","return"].forEach((function(e){d(t,e,(function(t){return this._invoke(e,t)}))}))}function j(e,n){function r(o,a,l,c){var s=b(e[o],e,a);if("throw"!==s.type){var u=s.arg,d=u.value;return d&&"object"==t(d)&&i.call(d,"__await")?n.resolve(d.__await).then((function(t){r("next",t,l,c)}),(function(t){r("throw",t,l,c)})):n.resolve(d).then((function(t){u.value=t,l(u)}),(function(t){return r("throw",t,l,c)}))}c(s.arg)}var o;a(this,"_invoke",{value:function(t,e){function i(){return new n((function(n,o){r(t,e,n,o)}))}return o=o?o.then(i,i):i()}})}function _(t,e,r){var o=h;return function(i,a){if(o===g)throw new Error("Generator is already running");if(o===m){if("throw"===i)throw a;return{value:n,done:!0}}for(r.method=i,r.arg=a;;){var l=r.delegate;if(l){var c=S(l,r);if(c){if(c===v)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=g;var s=b(t,e,r);if("normal"===s.type){if(o=r.done?m:f,s.arg===v)continue;return{value:s.arg,done:r.done}}"throw"===s.type&&(o=m,r.method="throw",r.arg=s.arg)}}}function S(t,e){var r=e.method,o=t.iterator[r];if(o===n)return e.delegate=null,"throw"===r&&t.iterator.return&&(e.method="return",e.arg=n,S(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),v;var i=b(o,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,v;var a=i.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=n),e.delegate=null,v):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,v)}function B(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function N(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function P(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(B,this),this.reset(!0)}function T(e){if(e||""===e){var r=e[c];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,a=function t(){for(;++o<e.length;)if(i.call(e,o))return t.value=e[o],t.done=!1,t;return t.value=n,t.done=!0,t};return a.next=a}}throw new TypeError(t(e)+" is not iterable")}return y.prototype=x,a(L,"constructor",{value:x,configurable:!0}),a(x,"constructor",{value:y,configurable:!0}),y.displayName=d(x,u,"GeneratorFunction"),r.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},r.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,x):(t.__proto__=x,d(t,u,"GeneratorFunction")),t.prototype=Object.create(L),t},r.awrap=function(t){return{__await:t}},E(j.prototype),d(j.prototype,s,(function(){return this})),r.AsyncIterator=j,r.async=function(t,e,n,o,i){void 0===i&&(i=Promise);var a=new j(p(t,e,n,o),i);return r.isGeneratorFunction(e)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(L),d(L,u,"Generator"),d(L,c,(function(){return this})),d(L,"toString",(function(){return"[object Generator]"})),r.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},r.values=T,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(N),!t)for(var e in this)"t"===e.charAt(0)&&i.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=n)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function r(r,o){return l.type="throw",l.arg=t,e.next=r,o&&(e.method="next",e.arg=n),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],l=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var c=i.call(a,"catchLoc"),s=i.call(a,"finallyLoc");if(c&&s){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),N(n),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;N(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:T(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=n),v}},r}function n(t,e,n,r,o,i,a){try{var l=t[i](a),c=l.value}catch(t){return void n(t)}l.done?e(c):Promise.resolve(c).then(r,o)}function r(t){return function(){var e=this,r=arguments;return new Promise((function(o,i){var a=t.apply(e,r);function l(t){n(a,o,i,l,c,"next",t)}function c(t){n(a,o,i,l,c,"throw",t)}l(void 0)}))}}$((function(){return r(e().mark((function t(){var n,o,i,a,l,c,s,u,d,p,b,h,f,g,m;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(["special:bulkmove","special:批量移动","special:批量移動","特殊:bulkmove"].includes(mw.config.get("wgPageName").toLowerCase())){t.next=5;break}return t.next=3,mw.loader.using(["mediawiki.util"]);case 3:return mw.util.addPortletLink("p-tb","/Special:BulkMove","批量移动","t-bulkmove"),t.abrupt("return");case 5:return t.next=7,mw.loader.using(["mediawiki.api","oojs-ui","mediawiki.user"]);case 7:n=new mw.Api,o=0,i=0,a=0,l=function(t){return new Promise((function(e){return setTimeout(e,t)}))},c=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=0;e<t;e++)o++,$("#bm-page-list-table tbody").append($("<tr>").append($('<td><input type="text" data-row-no="'.concat(o,'" data-col-no="1" name="').concat(o,'-1"></td>'))).append($('<td><input type="text" data-row-no="'.concat(o,'" data-col-no="2" name="').concat(o,'-2"></td>'))).append($('<td><div class="remove-row oo-ui-icon-subtract" title="删除此行"></div></td>')))},s=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"normal";$("#bearbintools-log-lines").append('<li class="log-'.concat(e,'">').concat((new Date).toLocaleTimeString()," - ").concat(t,"</li>"));var n=document.getElementById("bearbintools-log-lines");n.scrollTop=n.scrollHeight},mw.config.set("wgCanonicalSpecialPageName","BulkMove"),$("title").text("批量移动 - 萌娘百科_万物皆可萌的百科全书"),$("head").append('<style>\n        #firstHeading {\n            display: flex;\n            flex-wrap: wrap;\n            justify-content: space-between;\n            align-items: flex-end;\n        }\n        #firstHeading>div {\n            font-size: .6em;\n        }\n        #bodyContent {\n            padding-right: 0 !important;\n        }\n        #mw-content-text h3 {\n            margin-bottom: 0;\n        }\n        #bm-page-list-table {\n            border-collapse: collapse;\n            width: 100%;\n            max-width: 900px;\n        }\n        #bm-page-list-table tbody {\n            counter-reset: row-counter;\n        }\n        #bm-page-list-table tbody tr {\n            counter-increment: row-counter;\n        }\n        #bm-page-list-table tbody tr:before {\n            content: counter(row-counter);\n            display: table-cell;\n            width: 0;\n            padding-right: .3em;\n            text-align: center;\n            vertical-align: middle;\n        }\n        #bm-page-list-table td {\n            padding: 0;\n            border: 1px solid #aaa;\n            background-color: rgba(255, 255, 255, .7);\n        }\n        #bm-page-list-table th:last-child,\n        #bm-page-list-table td:last-child {\n            border: none;\n            width: 20px;\n            background-position: center;\n            background-color: transparent;\n        }\n        #bm-add-row, .remove-row {\n            width: 20px;\n            height: 20px;\n            cursor: pointer;\n            border-radius: 50%;\n            transition: .2s ease background;\n        }\n        #bm-add-row:hover, .remove-row:hover {\n            background-color: rgba(127, 127, 127, .2)\n        }\n        /* 傻逼萌皮 */\n        #mw-content-text #bm-page-list-table input[type="text"] {\n            box-sizing: border-box;\n            width: 100%;\n            height: 100%;\n            padding: .4em;\n            border: none;\n            border-radius: 0;\n            background: transparent;\n        }\n        #mw-content-text #bm-page-list-table input[type="text"]:focus {\n            outline: none;\n            background-color: rgba(127, 127, 127, .02);\n        }\n        #mw-content-text ul.bearbintools-notelist {\n            margin: .4em 0 0 1.6em;\n        }\n        #bm-submit-panel, #bm-option {\n            margin-top: .8em;\n        }\n        #bm-submit-panel {\n            display: flex;\n            gap: .1rem;\n        }\n        #bm-interval {\n            flex: 0 0 5.5em;\n        }\n        #bm-summary {\n            max-width: initial;\n        }\n        #bm-option>div {\n            margin-top: .3em;\n        }\n        .state {\n            display: inline-block;\n            width: 1.2em;\n            height: 1em;\n            line-height: 1em;\n            text-align: center;\n        }\n        #bearbintools-log {\n            display: flow-root;\n            padding: .3em;\n            border: 1px solid #ccc;\n            background: rgba(255, 255, 255, .7);\n        }\n        #bearbintools-log-clear {\n            padding-left: .5em;\n            font-size: 1rem;\n            font-weight: 400;\n            user-select: none;\n        }\n        #bearbintools-log-state {\n            float: right;\n            padding: .4em;\n        }\n        #bearbintools-log-state>div {\n            border-radius: 0.3em;\n            margin-bottom: 0.2em;\n            padding-right: 0.2em;\n            cursor: pointer;\n        }\n        #bearbintools-log-state>div.log-selected {\n            background-color: rgba(127, 127, 127, .07);\n        }\n        #bearbintools-log-lines.log-success-hide .log-success,\n        #bearbintools-log-lines.log-nochange-hide .log-nochange,\n        #bearbintools-log-lines.log-error-hide .log-error,\n        #bearbintools-log-lines.log-warn-hide .log-warn {\n            display: none;\n        }\n        .log-success {\n            color: #333;\n        }\n        .log-nochange {\n            color: #888;\n        }\n        .log-warn {\n            color: #f28500;\n        }\n        .log-error {\n            color: #eb3941;\n        }\n        #bearbintools-log-lines {\n            font-family: monospace;\n        }\n        #bearbintools-log-lines a {\n            color: inherit;\n            text-decoration: underline dotted;\n        }\n    </style>'),$(".mw-invalidspecialpage").removeClass("mw-invalidspecialpage"),$("#firstHeading").html("批量移动页面<div>By BearBin</div>"),$("#contentSub").remove(),$("#mw-content-text").html('\n        <h3>页面列表</h3>\n        <table id="bm-page-list-table">\n            <thead>\n                <tr>\n                    <th></th>\n                    <th>源页面</th>\n                    <th>目标页面</th>\n                    <th><div class="oo-ui-icon-add" id="bm-add-row" title="新增一行"></div></th>\n                </tr>\n            </thead>\n            <tbody></tbody>\n        </table>\n        <ul class="bearbintools-notelist">\n            <li>请输入要移动的页面列表及目标页面，一一对应。</li>\n            <li>点击右上角“+”添加一行，长按可连续添加。</li>\n            <li>可直接从Excel复制（部分浏览器可能不支持）。复制粘贴时浏览器可能会需要获取权限，请注意是否有提醒。</li>\n        </ul>\n        <div id="bm-option"></div>\n        <div id="bm-submit-panel"></div>\n        <ul class="bearbintools-notelist">\n            <li>操作间隔单位为秒（s），不填默认为0。不包含本身移动页面所用的服务器响应时间。</li>\n            <li>请注意<a target="_blank" href="/萌娘百科:机器用户">机器用户方针</a>所规定的速率和<a target="_blank" href="/api.php?action=query&meta=userinfo&uiprop=ratelimits">ratelimit限制</a>并自行设置间隔，或申请机器用户权限。</li>\n        </ul>\n        <h3 id="bearbintools-log-title">日志<a id="bearbintools-log-clear">[清空]</a></h3>\n        <div id="bearbintools-log">\n            <div id="bearbintools-log-state">\n                <div class="log-success log-selected" id="log-success"><span class="state">✓</span><span id="state-success">0</span> 完成</div>\n                <div class="log-error log-selected" id="log-error"><span class="state">✕</span><span id="state-error">0</span> 出错</div>\n                <div class="log-warn log-selected" id="log-warn"><span class="state">!</span><span id="state-error">0</span> 警告</div>\n            </div>\n            <ul id="bearbintools-log-lines"></ul>\n        </div>\n    '),c(10),u=new OO.ui.FieldLayout(new OO.ui.CheckboxInputWidget({id:"bm-movetalk-box",selected:!0}),{label:"移动关联的讨论页",align:"inline",id:"bm-movetalk"}),d=new OO.ui.CheckboxInputWidget({id:"bm-redirect-box"}),p=new OO.ui.FieldLayout(d,{label:"保留重定向",align:"inline",id:"bm-redirect"}),b=new OO.ui.FieldLayout(new OO.ui.CheckboxInputWidget({id:"bm-watchlist-box"}),{label:"监视源页面和目标页面",align:"inline",id:"bm-watchlist"}),$("#bm-option").append(u.$element,p.$element,b.$element),h=new OO.ui.ButtonWidget({label:"提交",flags:["primary","progressive"],icon:"check",id:"bm-submit"}),f=new OO.ui.TextInputWidget({placeholder:"操作间隔",id:"bm-interval"}),g=new OO.ui.TextInputWidget({placeholder:"附加摘要",id:"bm-reason",name:"wpReason"}),$("#bm-submit-panel").append(h.$element,f.$element,g.$element),mw.user.getRights().done((function(t){t.includes("suppressredirect")||d.setSelected(!0).setDisabled(!0)})),$("#bm-add-row").on("mousedown",(function(){m=setInterval((function(){c()}),200)})).on("mouseup",(function(){clearInterval(m),c()})),$("#bm-page-list-table").on("click",".remove-row",(function(){o--,$(this).closest("tr").remove(),$("#bm-page-list-table tbody tr").each((function(t,e){$(e).find("input").attr("data-row-no",t+1)}))})),$("#bm-page-list-table").on("paste",'input[type="text"]',(function(t){var e=this;navigator.clipboard.readText().then((function(n){if(n.indexOf("\t")>-1||n.indexOf("\n")>-1&&n.indexOf("\n")!==n.length-1){t.preventDefault();for(var r=n.split("\n"),o=$("#bm-page-list-table input[data-row-no][data-col-no]"),i=0;i<r.length;i++)for(var a=r[i].split("\t"),l=0;l<2;l++){var c;if((null===(c=a[l])||void 0===c?void 0:c.trim().length)>0){var s=i+Number($(e).attr("data-row-no")),u=l+Number($(e).attr("data-col-no"));o.filter('[data-row-no="'.concat(s,'"][data-col-no="').concat(u,'"]')).val(a[l])}}}}))})),$("#bearbintools-log-clear").on("click",(function(){$("#bearbintools-log-lines").html(""),$("#state-success, #state-warn, #state-error").text(0),i=0,a=0})),$("#bearbintools-log-state>div").each((function(t,e){var n=!0,r=$(e);r.on("click",(function(t){t.preventDefault(),n?($("#bearbintools-log-lines").addClass("".concat(r.attr("id"),"-hide")),r.removeClass("log-selected"),n=!1):($("#bearbintools-log-lines").removeClass("".concat(r.attr("id"),"-hide")),r.addClass("log-selected"),n=!0)}))})),h.on("click",r(e().mark((function t(){var r,o,c,u,d,p,b,m,v,w,y,x,k,O;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=$("<p>请确认您的移动是否有误。若因输入不当而产生错误，请自行<ruby><rb>承担后果</rb><rp>(</rp><rt>料理后事</rt><rp>)</rp></ruby>。</p>"),t.next=3,OO.ui.confirm(r,{title:"提醒",size:"small"});case 3:if(!t.sent){t.next=55;break}h.setDisabled(!0),window.onbeforeunload=function(){return!0},$("#mw-content-text input, #mw-content-text textarea").prop("disabled",!0),o=$("#bm-movetalk-box input").prop("checked"),c=!$("#bm-redirect-box input").prop("checked"),u=$("#bm-watchlist-box input").prop("checked")?"watch":"unwatch",d=g.getValue().length>0?"[[User:BearBin/js#批量移动页面|BulkMove]]：".concat(g.getValue()):"[[User:BearBin/js#批量移动页面|BulkMove]]",p=1e3*Number(f.getValue()),b=mw.config.get("wgUserGroups").includes("bot")?"bot":"Automation tool",m=[],$("#bm-page-list-table tbody tr").each((function(t,e){var n=$(e).find("input")[0].value,r=$(e).find("input")[1].value;(null==n?void 0:n.length)>0&&(null==r?void 0:r.length)>0&&m.push({from:n,to:r})})),m.length>0?s("共".concat(m.length,"个页面，即将开始移动。")):s("没有要移动的页面。"),v=0,w=m;case 18:if(!(v<w.length)){t.next=51;break}return y=w[v],x=y.from,k=y.to,t.prev=22,t.next=25,n.postWithToken("csrf",{format:"json",action:"move",from:x,to:k,movetalk:o,noredirect:c,watchlist:u,reason:d,tags:b,bot:!0});case 25:if(!t.sent.move){t.next=31;break}return s('移动【<a href="/'.concat(x).concat(c?"":"?redirect=no",'" class="').concat(c?"":"mw-redirect",'">').concat(x,'</a>】→【<a href="/').concat(k,'">').concat(k,"</a>】成功。"),"success"),$("#state-success").text(++i),t.next=31,l(p);case 31:t.next=48;break;case 33:t.prev=33,t.t0=t.catch(22),O="",t.t1=t.t0,t.next="missingtitle"===t.t1?39:"articleexists"===t.t1?41:"http"===t.t1?43:45;break;case 39:return O="源页面不存在",t.abrupt("break",46);case 41:return O="目标页面已存在",t.abrupt("break",46);case 43:return O="网络连接出错",t.abrupt("break",46);case 45:O=t.t0;case 46:s('移动【<a href="/'.concat(x,'">').concat(x,'</a>】→【<a href="/').concat(k,'">').concat(k,"</a>】失败：").concat(O,"。"),"error"),$("#state-error").text(++a);case 48:v++,t.next=18;break;case 51:s("移动完毕。"),h.setDisabled(!1),window.onbeforeunload=function(){return null},$("#mw-content-text input, #mw-content-text textarea").prop("disabled",!1);case 55:case"end":return t.stop()}}),t,null,[[22,33]])}))));case 38:case"end":return t.stop()}}),t)})))()}))})();