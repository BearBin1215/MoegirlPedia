(()=>{"use strict";var e={},t={};function i(n){var o=t[n];if(void 0!==o)return o.exports;var l=t[n]={exports:{}};return e[n](l,l.exports,i),l.exports}i.rv=()=>"1.4.11",i.ruid="bundler=rspack@1.4.11";let n=async(e,t)=>{let i=new mw.Api,[n]=Object.values((await i.post({action:"query",prop:"revisions",titles:e,rvprop:"content",...t})).query.pages);if("revisions"in n)return n.revisions?.[0]["*"];if("missing"in n)throw"missingtitle"};$(()=>(async()=>{if(6===mw.config.get("wgNamespaceNumber")){await mw.loader.using(["mediawiki.api","mediawiki.ForeignApi","mediawiki.notification","oojs-ui"]);let e=new mw.Api,t=new mw.ForeignApi("https://mzh.moegirl.org.cn/api.php"),i=mw.config.get("wgTitle"),o=mw.config.get("wgPageName"),l=[],a='<div id="funl-note">请注意：对过短的文件名使用本工具可能会出现误判，建议手动检查。</div>';mw.config.get("wgIsRedirect")?$(".redirectMsg").after("<hr/>",a):$("#filelinks").after(a);let r=new OO.ui.ButtonWidget({label:"查询非链入使用",flags:"progressive",icon:"search"}),s=r.$element.children("a");$("#funl-note").after(r.$element);let c=new OO.ui.ButtonWidget({label:"标记非链入使用",flags:"progressive",icon:"tag"}),m=c.$element.children("a");r.$element.after(c.$element);let p=new OO.ui.ButtonWidget({label:"移除非链入标记",flags:"progressive",icon:"tag"}),u=p.$element.children("a");c.$element.after(p.$element),c.$element.hide(),p.$element.hide(),p.$element.after('<div id="search-result" style="margin:.6em 0"><div id="result-overview"></div><ul id="result-list"></ul></div><hr/>');let d=async e=>await t.get({action:"query",list:"search",srnamespace:["0","4","10","12","14","274","828"],srwhat:"text",srprop:"snippet",srsearch:e}),g=async()=>{let[e,t]=await Promise.all([d(`insource:"${i.replaceAll('"'," ")}"`),d(`insource:"${encodeURI(i).replaceAll('"'," ").replaceAll("%20"," ")}"`)]),n=[];[...t.query.search,...e.query.search].forEach(e=>{((e,t)=>{let i=t.replaceAll("_"," "),n=i.charAt(0),o=i.slice(1);return[n.toLowerCase()+o,n.toUpperCase()+o].some(t=>e.includes(t)||e.includes(encodeURI(t))||e.includes(encodeURI(t).replaceAll("%20"," ")))})(e.snippet.replaceAll("_"," ").replaceAll('<span class="searchmatch">',"").replaceAll("</span>",""),i)&&n.push(e.title)});let o=new Set([...$(".mw-gu-onwiki-zh_moegirl_org_cn a").map((e,{text:t})=>t).get()]),l=n.filter(e=>!o.has(e));return 0===l.length?($("#result-overview").text("zh站没有查找到非链入使用此文件的页面。"),[]):($("#result-overview").text("文件在以下页面以非内链形式使用："),l=[...new Set(l)],$("#result-list").append(...l.map(e=>`<li><a href="https://zh.moegirl.org.cn/${e}">zhmoe:${e}</a></li>`)),s.removeClass("oo-ui-pendingElement-pending"),l)},w=async()=>{mw.notify("正在标记……"),m.addClass("oo-ui-pendingElement-pending");let t=l.map(e=>`[[zhmoe:${e}]]`).join("、");try{await e.postWithToken("csrf",{format:"json",action:"edit",watchlist:"nochange",tags:"Automation tool",minor:!0,title:o,appendtext:`{{\u{975E}\u{94FE}\u{5165}\u{4F7F}\u{7528}|${t}}}`,summary:"标记非链入使用的文件"}).done(()=>{mw.notify("标记成功！将在2秒后刷新……"),m.removeClass("oo-ui-pendingElement-pending"),setTimeout(()=>{window.location.reload()},2e3)})}catch(e){mw.notify(`\u{6807}\u{8BB0}\u{5931}\u{8D25}\u{FF1A}${e}`,{type:"error"})}},h=async()=>{mw.notify("正在移除标记……"),u.addClass("oo-ui-pendingElement-pending");try{let t=(await n(o)).replace(/\{\{非链入使用\|[^{}]*\}\}/g,"");await e.postWithToken("csrf",{format:"json",action:"edit",watchlist:"nochange",tags:"Automation tool",minor:!0,nocreate:!0,title:o,text:t,summary:"移除非链入使用标记"}).done(()=>{mw.notify("移除成功！将在2秒后刷新……"),u.removeClass("oo-ui-pendingElement-pending"),setTimeout(()=>{window.location.reload()},2e3)})}catch(e){mw.notify(`\u{79FB}\u{9664}\u{5931}\u{8D25}\u{FF1A}${e}`,{type:"error"})}};r.on("click",async()=>{mw.notify("正在查询……"),s.addClass("oo-ui-pendingElement-pending"),(l=await g()).length&&0===$(".used-not-linked").length?c.$element.show():0===l.length&&$(".used-not-linked").length&&p.$element.show(),mw.notify("查询完毕"),s.removeClass("oo-ui-pendingElement-pending")}),c.on("click",w),p.on("click",h)}})())})();
//# sourceMappingURL=FileUsedNotLinked.min.js.map