$((()=>(async()=>{if(6===mw.config.get("wgNamespaceNumber")){await mw.loader.using(["mediawiki.api","mediawiki.ForeignApi","mediawiki.notification","oojs-ui"]);const e=new mw.Api,t=new mw.ForeignApi("https://mobile.moegirl.org.cn/api.php",{anonymous:!0}),n=mw.config.get("wgTitle"),i=mw.config.get("wgPageName");let o=[];mw.config.get("wgIsRedirect")?$(".redirectMsg").after('<hr/><div id="funl-note">请注意：对过短的文件名使用本工具可能会出现误判，建议手动检查。</div>'):$("#filelinks").after('<div id="funl-note">请注意：对过短的文件名使用本工具可能会出现误判，建议手动检查。</div>');const a=new OO.ui.ButtonWidget({label:"查询非链入使用",flags:"progressive",icon:"search",id:"search-submit-button"});$("#funl-note").after(a.$element);const r=new OO.ui.ButtonWidget({label:"标记非链入使用",flags:"progressive",icon:"tag",id:"add-mark-button"});a.$element.after(r.$element);const s=new OO.ui.ButtonWidget({label:"移除非链入标记",flags:"progressive",icon:"tag",id:"remove-mark-button"});r.$element.after(s.$element),r.$element.hide(),s.$element.hide(),s.$element.after('<div id="search-result" style="margin:.6em 0"><div id="result-overview"></div><ul id="result-list"></ul></div><hr/>');const l=()=>{const e=[];for(const t of $(".mw-gu-onwiki-zh_moegirl_org_cn").find("a"))e.push(t.text);return e},c=async()=>{const e=await t.get({action:"query",list:"search",srnamespace:"0|4|10|12|14|274|828",srwhat:"text",srsearch:'insource:"'.concat(n.replaceAll('"'," "),'"')}),i=await t.get({action:"query",list:"search",srnamespace:"0|4|10|12|14|274|828",srwhat:"text",srsearch:'insource:"'.concat(encodeURI(n).replaceAll('"'," ").replaceAll("%20"," "),'"')}),o=[];[...i.query.search,...e.query.search].forEach((e=>{const t=e.snippet.replaceAll("_"," ").replaceAll('<span class="searchmatch">',"").replaceAll("</span>","");(t.includes(n.replaceAll("_"," "))||t.includes(encodeURI(n.replaceAll("_"," ")))||t.includes(encodeURI(n.replaceAll("_"," ")).replaceAll("%20"," ")))&&o.push(e.title)}));const a=new Set([...l()]);let r=o.filter((e=>!a.has(e)));if(0===r.length)return $("#result-overview").text("zh站没有查找到非链入使用此文件的页面。"),[];$("#result-overview").text("文件在以下页面以非内链形式使用："),r=[...new Set(r)];for(const e of r)$("#result-list").append('<li><a href="https://zh.moegirl.org.cn/'.concat(e,'">zhmoe:').concat(e,"</a></li>"));return $("#search-submit-button a").removeClass("oo-ui-pendingElement-pending"),r},m=async()=>{mw.notify("正在标记……"),$("#add-mark-button a").addClass("oo-ui-pendingElement-pending");const t="[[zhmoe:".concat(o.join("]]、[[zhmoe:"),"]]");try{await e.postWithToken("csrf",{format:"json",action:"edit",watchlist:"nochange",tags:"Automation tool",minor:!0,title:i,appendtext:"{{非链入使用|".concat(t,"}}"),summary:"标记非链入使用的文件"}).done((()=>{mw.notify("标记成功！将在2秒后刷新……"),$("#add-mark-button a").removeClass("oo-ui-pendingElement-pending"),setTimeout((()=>{window.location.reload()}),2e3)}))}catch(e){mw.notify("标记失败：".concat(e),"error")}},d=async()=>{mw.notify("正在移除标记……"),$("#remove-mark-button a").addClass("oo-ui-pendingElement-pending");try{let t=await e.get({action:"parse",format:"json",page:i,prop:"wikitext"});t=t.parse.wikitext["*"];const n=t.replace(/\{\{非链入使用\|[^{}]*\}\}/g,"");await e.postWithToken("csrf",{format:"json",action:"edit",watchlist:"nochange",tags:"Automation tool",minor:!0,nocreate:!0,title:i,text:n,summary:"移除非链入使用标记"}).done((()=>{mw.notify("移除成功！将在2秒后刷新……"),$("#remove-mark-button a").removeClass("oo-ui-pendingElement-pending"),setTimeout((()=>{window.location.reload()}),2e3)}))}catch(e){mw.notify("移除失败：".concat(e),"error")}};a.on("click",(async()=>{mw.notify("正在查询……"),$("#search-submit-button a").addClass("oo-ui-pendingElement-pending"),o=await c(),o.length>0&&0===$(".used-not-linked").length?r.$element.show():0===o.length&&$(".used-not-linked").length>0&&s.$element.show(),mw.notify("查询完毕"),$("#search-submit-button a").removeClass("oo-ui-pendingElement-pending")})),r.on("click",(()=>{m()})),s.on("click",(()=>{d()}))}})()));