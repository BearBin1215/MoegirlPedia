{"version":3,"file":"ShowContributors.min.js","sources":["webpack://bearbin-moegirlpedia/webpack/runtime/rspack_version","webpack://bearbin-moegirlpedia/webpack/runtime/rspack_unique_id","webpack://bearbin-moegirlpedia/./src/gadgets/ShowContributors/index.ts"],"sourcesContent":["__webpack_require__.rv = () => (\"1.4.2\")","__webpack_require__.ruid = \"bundler=rspack@1.4.2\";\n","import type { ApiParams, ApiQueryResponse } from '@/@types/api';\r\nimport styles from './index.inline.less';\r\n\r\ninterface UserContribution {\r\n  user: string;\r\n  count: number;\r\n  add: number;\r\n  remove: number;\r\n}\r\n\r\n$(() => (async () => {\r\n  if (\r\n    ![0, 2, 4, 10, 12, 14, 828, 274].includes(mw.config.get('wgNamespaceNumber')) ||\r\n    mw.config.get('wgArticleId') === 0 ||\r\n    !['view', 'history'].includes(mw.config.get('wgAction'))\r\n  ) { return; }\r\n  mw.loader.addStyleTag(styles);\r\n  await mw.loader.using([\r\n    'mediawiki.api',\r\n    'mediawiki.notification',\r\n    'oojs-ui',\r\n    'oojs-ui.styles.icons-interactions', // 提供关闭窗口按钮\r\n    'jquery.tablesorter', // 提供表格排序功能\r\n  ]);\r\n  class ContributorDialog extends OO.ui.Dialog {\r\n    $table = $('<table id=\"show-contributor-table\" class=\"wikitable\" />') as JQuery<HTMLTableElement>;\r\n    $tbody = $('<tbody />') as JQuery<HTMLTableSectionElement>;\r\n    $head!: JQuery<HTMLDivElement>;\r\n    $body!: JQuery<HTMLDivElement>;\r\n    got = false;\r\n\r\n    static static = {\r\n      ...super.static,\r\n      name: 'ShowContributor',\r\n      tagName: 'div',\r\n    };\r\n    initialize() {\r\n      super.initialize();\r\n\r\n      this.$head.append('1');\r\n\r\n      this.$body.append(\r\n        $('<div id=\"show-contributor-header\" />').append(\r\n          $('<div id=\"show-contributor-headline\">本页贡献统计</div>'),\r\n          new OO.ui.IconWidget({\r\n            icon: 'close',\r\n            id: 'show-contributor-close',\r\n          }).$element.on('click', () => this.close()),\r\n        ),\r\n        this.$table.append(\r\n          $('<thead><th>用户</th><th>编辑数</th><th>增加字节数</th><th>删减字节数</th></thead>'),\r\n          this.$tbody,\r\n        ),\r\n      );\r\n      return this;\r\n    }\r\n\r\n    /**\r\n     * 获取贡献者\r\n     * @returns 贡献者及其编辑情况\r\n     */\r\n    getContributors = async () => {\r\n      const api = new mw.Api();\r\n      const contributors: Record<string, number[]> = {};\r\n      let rvcontinue: string | undefined = '';\r\n      let prevSize: number | undefined = 0; // 用于记录上次编辑的字节数\r\n      const config: ApiParams = {\r\n        action: 'query',\r\n        format: 'json',\r\n        prop: 'revisions',\r\n        titles: mw.config.get('wgPageName'),\r\n        rvprop: 'user|size',\r\n        rvlimit: 'max',\r\n        rvdir: 'newer',\r\n      };\r\n      do {\r\n        if (rvcontinue) {\r\n          config.rvcontinue = rvcontinue;\r\n        }\r\n        try {\r\n          const res = await api.get(config) as ApiQueryResponse;\r\n          rvcontinue = res.continue?.rvcontinue;\r\n          for (const { user, size } of Object.values(res.query.pages!)[0].revisions) {\r\n            contributors[user] ||= [];\r\n            contributors[user].push(size - prevSize);\r\n            prevSize = size;\r\n          }\r\n        } catch (error) {\r\n          mw.notify(`获取编辑记录失败：${error}`, { type: 'error' });\r\n        }\r\n      } while (rvcontinue);\r\n      return contributors;\r\n    };\r\n\r\n    // 向表格添加一行\r\n    addRow = ($tbody: JQuery<HTMLTableSectionElement>, { user, count, add, remove }: UserContribution) => {\r\n      $tbody.append($('<tr />').append(\r\n        $('<td />').append(\r\n          $(`<a href=\"${mw.config.get('wgArticlePath').replace('$1', `User:${user}`)}\" />`).append(\r\n            `<img class=\"user-avatar\" src=\"https://commons.moegirl.org.cn/extensions/Avatar/avatar.php?user=${user}\" />`,\r\n            user,\r\n          ),\r\n        ),\r\n        `<td>${count}</td>`,\r\n        `<td>${add}</td>`,\r\n        `<td>${remove}</td>`,\r\n      ));\r\n    };\r\n\r\n    // 分析数据，展示结果\r\n    showContributors = (contributors: Record<string, number[]>) => {\r\n      this.$tbody.empty();\r\n      for (const key in contributors) {\r\n        this.addRow(this.$tbody, {\r\n          user: key,\r\n          count: contributors[key].length,\r\n          add: contributors[key].reduce((acc, cur) => cur > 0 ? acc + cur : acc, 0),\r\n          remove: contributors[key].reduce((acc, cur) => cur < 0 ? acc + cur : acc, 0),\r\n        });\r\n      }\r\n      this.got = true;\r\n    };\r\n  }\r\n\r\n  const windowManager = new OO.ui.WindowManager({\r\n    id: 'show-contributor',\r\n  });\r\n  $(document.body).append(windowManager.$element);\r\n  const SCDialog = new ContributorDialog({\r\n    size: 'large',\r\n  });\r\n  windowManager.addWindows([SCDialog]);\r\n\r\n  const contributorButton = new OO.ui.ButtonWidget({\r\n    label: '本页贡献者',\r\n    icon: 'search',\r\n    flags: 'progressive',\r\n    id: 'show-contributor-button',\r\n  });\r\n  switch (mw.config.get('skin')) {\r\n    case 'moeskin':\r\n      $('#tagline').prepend(contributorButton.$element);\r\n      break;\r\n    case 'vector':\r\n    default:\r\n      $('#bodyContent').prepend(contributorButton.$element);\r\n      break;\r\n  }\r\n\r\n  contributorButton.on('click', async () => {\r\n    if (!SCDialog.got) {\r\n      contributorButton.setLabel('正在查询');\r\n      const contributors = await SCDialog.getContributors();\r\n      SCDialog.showContributors(contributors);\r\n      SCDialog.$table.tablesorter();\r\n      contributorButton.setLabel('本页贡献者');\r\n    }\r\n    windowManager.openWindow(SCDialog);\r\n  });\r\n})());\r\n"],"names":["$","mw","ContributorDialog","OO","api","contributors","rvcontinue","prevSize","config","res","user","size","Object","error","$tbody","count","add","remove","key","acc","cur","windowManager","document","SCDialog","contributorButton"],"mappings":"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"}