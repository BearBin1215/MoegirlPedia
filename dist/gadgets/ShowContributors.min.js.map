{"version":3,"file":"ShowContributors.min.js","sources":["webpack://bearbin-moegirlpedia/webpack/runtime/rspack_version","webpack://bearbin-moegirlpedia/webpack/runtime/rspack_unique_id","webpack://bearbin-moegirlpedia/./src/gadgets/ShowContributors/index.ts"],"sourcesContent":["__webpack_require__.rv = () => (\"1.4.11\")","__webpack_require__.ruid = \"bundler=rspack@1.4.11\";\n","import type { ApiParams, ApiQueryResponse } from '@/@types/api';\nimport styles from './index.inline.less';\n\ninterface UserContribution {\n  user: string;\n  count: number;\n  add: number;\n  remove: number;\n}\n\n$(() => (async () => {\n  if (\n    ![0, 2, 4, 10, 12, 14, 828, 274].includes(mw.config.get('wgNamespaceNumber')) ||\n    mw.config.get('wgArticleId') === 0 ||\n    !['view', 'history'].includes(mw.config.get('wgAction'))\n  ) { return; }\n  mw.loader.addStyleTag(styles);\n  await mw.loader.using([\n    'mediawiki.api',\n    'mediawiki.notification',\n    'oojs-ui',\n    'oojs-ui.styles.icons-interactions', // 提供关闭窗口按钮\n    'jquery.tablesorter', // 提供表格排序功能\n  ]);\n  class ContributorDialog extends OO.ui.Dialog {\n    $table = $('<table id=\"show-contributor-table\" class=\"wikitable\" />') as JQuery<HTMLTableElement>;\n    $tbody = $('<tbody />') as JQuery<HTMLTableSectionElement>;\n    $head!: JQuery<HTMLDivElement>;\n    $body!: JQuery<HTMLDivElement>;\n    got = false;\n\n    static static = {\n      ...super.static,\n      name: 'ShowContributor',\n      tagName: 'div',\n    };\n    initialize() {\n      super.initialize();\n\n      this.$body.append(\n        $('<div id=\"show-contributor-header\" />').append(\n          $('<div id=\"show-contributor-headline\">本页贡献统计</div>'),\n          new OO.ui.IconWidget({\n            icon: 'close',\n            id: 'show-contributor-close',\n          }).$element.on('click', () => this.close()),\n        ),\n        this.$table.append(\n          $('<thead><th>用户</th><th>编辑数</th><th>增加字节数</th><th>删减字节数</th></thead>'),\n          this.$tbody,\n        ),\n      );\n      return this;\n    }\n\n    /**\n     * 获取贡献者\n     * @returns 贡献者及其编辑情况\n     */\n    getContributors = async () => {\n      const api = new mw.Api();\n      const contributors: Record<string, number[]> = {};\n      let rvcontinue: string | undefined = '';\n      let prevSize: number | undefined = 0; // 用于记录上次编辑的字节数\n      const config: ApiParams = {\n        action: 'query',\n        format: 'json',\n        prop: 'revisions',\n        titles: mw.config.get('wgPageName'),\n        rvprop: 'user|size',\n        rvlimit: 'max',\n        rvdir: 'newer',\n      };\n      do {\n        if (rvcontinue) {\n          config.rvcontinue = rvcontinue;\n        }\n        try {\n          const res = await api.get(config) as ApiQueryResponse;\n          rvcontinue = res.continue?.rvcontinue;\n          for (const { user, size } of Object.values(res.query.pages!)[0].revisions) {\n            contributors[user] ||= [];\n            contributors[user].push(size - prevSize);\n            prevSize = size;\n          }\n        } catch (error) {\n          mw.notify(`获取编辑记录失败：${error}`, { type: 'error' });\n        }\n      } while (rvcontinue);\n      return contributors;\n    };\n\n    // 向表格添加一行\n    addRow = ($tbody: JQuery<HTMLTableSectionElement>, { user, count, add, remove }: UserContribution) => {\n      $tbody.append($('<tr />').append(\n        $('<td />').append(\n          $(`<a href=\"${mw.config.get('wgArticlePath').replace('$1', `User:${user}`)}\" />`).append(\n            `<img class=\"user-avatar\" src=\"https://commons.moegirl.org.cn/extensions/Avatar/avatar.php?user=${user}\" />`,\n            user,\n          ),\n        ),\n        `<td>${count}</td>`,\n        `<td>${add}</td>`,\n        `<td>${remove}</td>`,\n      ));\n    };\n\n    // 分析数据，展示结果\n    showContributors = (contributors: Record<string, number[]>) => {\n      this.$tbody.empty();\n      for (const key in contributors) {\n        this.addRow(this.$tbody, {\n          user: key,\n          count: contributors[key].length,\n          add: contributors[key].reduce((acc, cur) => cur > 0 ? acc + cur : acc, 0),\n          remove: contributors[key].reduce((acc, cur) => cur < 0 ? acc + cur : acc, 0),\n        });\n      }\n      this.got = true;\n    };\n  }\n\n  const windowManager = new OO.ui.WindowManager({\n    id: 'show-contributor',\n  });\n  $(document.body).append(windowManager.$element);\n  const SCDialog = new ContributorDialog({\n    size: 'large',\n  });\n  windowManager.addWindows([SCDialog]);\n\n  const contributorButton = new OO.ui.ButtonWidget({\n    label: '本页贡献者',\n    icon: 'search',\n    flags: 'progressive',\n    id: 'show-contributor-button',\n  });\n  switch (mw.config.get('skin')) {\n    case 'moeskin':\n      $('#tagline').prepend(contributorButton.$element);\n      break;\n    case 'vector':\n    default:\n      $('#bodyContent').prepend(contributorButton.$element);\n      break;\n  }\n\n  contributorButton.on('click', async () => {\n    if (!SCDialog.got) {\n      contributorButton.setLabel('正在查询');\n      const contributors = await SCDialog.getContributors();\n      SCDialog.showContributors(contributors);\n      SCDialog.$table.tablesorter();\n      contributorButton.setLabel('本页贡献者');\n    }\n    windowManager.openWindow(SCDialog);\n  });\n})());\n"],"names":["$","mw","ContributorDialog","OO","api","contributors","rvcontinue","prevSize","config","res","user","size","Object","error","$tbody","count","add","remove","key","acc","cur","windowManager","document","SCDialog","contributorButton"],"mappings":"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"}