{"version":3,"file":"FileUsedNotLinked.min.js","sources":["webpack://bearbin-moegirlpedia/webpack/runtime/rspack_version","webpack://bearbin-moegirlpedia/webpack/runtime/rspack_unique_id","webpack://bearbin-moegirlpedia/./src/utils/api/pageSource.ts","webpack://bearbin-moegirlpedia/./src/gadgets/FileUsedNotLinked/index.ts"],"sourcesContent":["__webpack_require__.rv = () => (\"1.4.11\")","__webpack_require__.ruid = \"bundler=rspack@1.4.11\";\n","import type { ApiQueryResponse } from '@/@types/api';\r\n\r\n/**\r\n * 获取页面源代码\r\n * @param title 页面标题\r\n * @returns 页面源代码\r\n */\r\nconst pageSource = async (title: string, params?: Record<string, any>): Promise<string | undefined> => {\r\n  const api = new mw.Api();\r\n  const res = await api.post({\r\n    action: 'query',\r\n    prop: 'revisions',\r\n    titles: title,\r\n    rvprop: 'content',\r\n    ...params,\r\n  }) as ApiQueryResponse;\r\n  const [pageData] = Object.values(res.query.pages);\r\n  if ('revisions' in pageData) {\r\n    return pageData.revisions?.[0]['*'];\r\n  }\r\n  if ('missing' in pageData) {\r\n    throw ('missingtitle');\r\n  }\r\n};\r\n\r\nexport default pageSource;\r\n","/**\n * @description 查询文件非链入使用。\n * @todo 标记时跳出窗口可选输入用途\n */\nimport { pageSource } from '@/utils/api';\nimport type { ApiQueryResponse } from \"@/@types/api\";\n\n$(() => (async () => {\n  // 本来想做一个检测当前页面文件存在不存在的，但想了想没啥必要。\n  if (mw.config.get('wgNamespaceNumber') === 6) {\n    await mw.loader.using(['mediawiki.api', 'mediawiki.ForeignApi', 'mediawiki.notification', 'oojs-ui']);\n    const api = new mw.Api();\n    const zhmoeApi = new mw.ForeignApi('https://mzh.moegirl.org.cn/api.php');\n    const FILENAME = mw.config.get('wgTitle');\n    const PAGENAME = mw.config.get('wgPageName');\n\n    let pageList: string[] = [];\n\n    // 重定向页面和其他页面元素有所区别，分别处理\n    const funlNote = '<div id=\"funl-note\">请注意：对过短的文件名使用本工具可能会出现误判，建议手动检查。</div>';\n    if (mw.config.get('wgIsRedirect')) {\n      $('.redirectMsg').after('<hr/>', funlNote);\n    } else {\n      $('#filelinks').after(funlNote);\n    }\n    // 搜索按钮\n    const searchButton = new OO.ui.ButtonWidget({\n      label: '查询非链入使用',\n      flags: 'progressive',\n      icon: 'search',\n    });\n    const $searchButtonAnchor = searchButton.$element.children('a');\n    $('#funl-note').after(searchButton.$element);\n\n    // 标记非链入使用按钮\n    const markButton = new OO.ui.ButtonWidget({\n      label: '标记非链入使用',\n      flags: 'progressive',\n      icon: 'tag',\n    });\n    const $markButtonLink = markButton.$element.children('a');\n    searchButton.$element.after(markButton.$element);\n\n    // 移除非链入使用标记按钮\n    const removeButton = new OO.ui.ButtonWidget({\n      label: '移除非链入标记',\n      flags: 'progressive',\n      icon: 'tag',\n    });\n    const $removeButtonAnchor = removeButton.$element.children('a');\n    markButton.$element.after(removeButton.$element);\n\n    markButton.$element.hide();\n    removeButton.$element.hide();\n    removeButton.$element.after(\n      '<div id=\"search-result\" style=\"margin:.6em 0\">' +\n      '<div id=\"result-overview\"></div>' +\n      '<ul id=\"result-list\"></ul>' +\n      '</div>' +\n      '<hr/>',\n    );\n\n    /**\n     * 直接在页面内获取链入使用的列表\n     * 最多获取50个，但多于50个的文件根本不需要使用此工具，所以不用考虑这个问题\n     * @returns 页面列表\n     */\n    const usedLinked = () => ($('.mw-gu-onwiki-zh_moegirl_org_cn a') as JQuery<HTMLAnchorElement>).map((_, { text }) => text).get();\n\n    /**\n     * 搜索\n     * @param srsearch 搜索文本\n     */\n    const search = async (srsearch: string) => {\n      return await zhmoeApi.get({\n        action: 'query',\n        list: 'search',\n        srnamespace: ['0', '4', '10', '12', '14', '274', '828'],\n        srwhat: 'text',\n        srprop: 'snippet',\n        srsearch,\n      }) as ApiQueryResponse;\n    };\n\n    /** 在字符串中匹配文件名，文件首字母大小写不敏感 */\n    const matchesFileName = (snippet: string, filename: string): boolean => {\n      const cleanFilename = filename.replaceAll('_', ' ');\n      const firstChar = cleanFilename.charAt(0);\n      const restOfString = cleanFilename.slice(1);\n\n      // 构造两种变体：首字母大写和小写\n      const variants = [\n        firstChar.toLowerCase() + restOfString,\n        firstChar.toUpperCase() + restOfString,\n      ];\n\n      // 对每种变体检查三种形式\n      return variants.some((variant) =>\n        snippet.includes(variant) ||\n        snippet.includes(encodeURI(variant)) ||\n        snippet.includes(encodeURI(variant).replaceAll('%20', ' ')),\n      );\n    };\n\n    // 搜索\n    const searchInSource = async () => {\n      // 需要分别搜索未编码和编码后的文件名\n      const [decodeSearchResult, encodeSearchResult] = await Promise.all([\n        search(`insource:\"${FILENAME.replaceAll('\"', ' ')}\"`), // 文件名可能带有半角双引号，和insource的引号混淆，要替换掉\n        search(`insource:\"${encodeURI(FILENAME).replaceAll('\"', ' ').replaceAll('%20', ' ')}\"`),\n      ]);\n\n      const notLinkedList: string[] = [];\n      [...encodeSearchResult.query.search!, ...decodeSearchResult.query.search!].forEach((item) => {\n        // 通过搜索结果的快照，检查搜索文本内是否有此文件名，用于解决大小写敏感问题\n        // 但文件名中的符号可能会影响<span class=\"searchmatch\">的位置插到文件名中间，因此要去掉这对标签\n        const snippetTemp = item.snippet.replaceAll('_', ' ').replaceAll('<span class=\"searchmatch\">', '').replaceAll('</span>', '');\n        console.log(snippetTemp, FILENAME);\n        if (matchesFileName(snippetTemp, FILENAME)) {\n          notLinkedList.push(item.title); // 合并两个搜索结果并得到页面列表\n        }\n      });\n\n      // 排除链入使用的页面\n      const used = new Set([...usedLinked()]);\n      let filtedPages = notLinkedList.filter((x) => !used.has(x));\n\n      if (filtedPages.length === 0) {\n        $('#result-overview').text('zh站没有查找到非链入使用此文件的页面。');\n        return [];\n      }\n      $('#result-overview').text('文件在以下页面以非内链形式使用：');\n\n      filtedPages = [...new Set(filtedPages)];\n      $('#result-list').append(\n        ...filtedPages.map((title) => `<li><a href=\"https://zh.moegirl.org.cn/${title}\">zhmoe:${title}</a></li>`),\n      );\n      $searchButtonAnchor.removeClass('oo-ui-pendingElement-pending');\n      return filtedPages;\n    };\n\n    /** 添加[[T:非链入使用]] */\n    const addMark = async () => {\n      mw.notify('正在标记……');\n      $markButtonLink.addClass('oo-ui-pendingElement-pending');\n      const linkList = pageList.map((title) => `[[zhmoe:${title}]]`).join('、'); // 将页面列表写为[[zhmoe:A]]、[[zhmoe:B]]、[[zhmoe:C]]……的形式\n      try {\n        await api.postWithToken('csrf', {\n          format: 'json',\n          action: 'edit',\n          watchlist: 'nochange',\n          tags: 'Automation tool',\n          minor: true,\n          title: PAGENAME,\n          appendtext: `{{非链入使用|${linkList}}}`,\n          summary: '标记非链入使用的文件',\n        }).done(() => {\n          mw.notify('标记成功！将在2秒后刷新……');\n          $markButtonLink.removeClass('oo-ui-pendingElement-pending');\n          setTimeout(() => {\n            window.location.reload();\n          }, 2000);\n        });\n      } catch (err) {\n        mw.notify(`标记失败：${err}`, { type: 'error' });\n      }\n    };\n\n    /** 移除[[T:非链入使用]] */\n    const removeMark = async () => {\n      mw.notify('正在移除标记……');\n      $removeButtonAnchor.addClass('oo-ui-pendingElement-pending');\n      try {\n        const source = await pageSource(PAGENAME);\n        const replacedSource = source!.replace(/\\{\\{非链入使用\\|[^{}]*\\}\\}/g, ''); // 移除非链入使用模板\n        await api.postWithToken('csrf', {\n          format: 'json',\n          action: 'edit',\n          watchlist: 'nochange',\n          tags: 'Automation tool',\n          minor: true,\n          nocreate: true,\n          title: PAGENAME,\n          text: replacedSource,\n          summary: '移除非链入使用标记',\n        }).done(() => {\n          mw.notify('移除成功！将在2秒后刷新……');\n          $removeButtonAnchor.removeClass('oo-ui-pendingElement-pending');\n          setTimeout(() => {\n            window.location.reload();\n          }, 2000);\n        });\n      } catch (err) {\n        mw.notify(`移除失败：${err}`, { type: 'error' });\n      }\n    };\n\n    // 执行体\n    searchButton.on('click', async () => {\n      mw.notify('正在查询……');\n      $searchButtonAnchor.addClass('oo-ui-pendingElement-pending');\n      pageList = await searchInSource();\n      if (pageList.length && $('.used-not-linked').length === 0) {\n        markButton.$element.show();\n      } else if (pageList.length === 0 && $('.used-not-linked').length) {\n        removeButton.$element.show();\n      }\n      mw.notify('查询完毕');\n      $searchButtonAnchor.removeClass('oo-ui-pendingElement-pending');\n    });\n\n    markButton.on('click', addMark);\n    removeButton.on('click', removeMark);\n  }\n})());\n"],"names":["pageSource","title","params","api","mw","pageData","Object","res","$","zhmoeApi","FILENAME","PAGENAME","pageList","funlNote","searchButton","OO","$searchButtonAnchor","markButton","$markButtonLink","removeButton","$removeButtonAnchor","search","srsearch","searchInSource","decodeSearchResult","encodeSearchResult","Promise","encodeURI","notLinkedList","item","matchesFileName","snippet","filename","cleanFilename","firstChar","restOfString","variants","variant","used","Set","_","text","filtedPages","x","addMark","linkList","setTimeout","window","err","removeMark","replacedSource","source"],"mappings":"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"}