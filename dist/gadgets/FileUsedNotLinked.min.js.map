{"version":3,"file":"FileUsedNotLinked.min.js","sources":["webpack://bearbin-moegirlpedia/webpack/runtime/rspack_version","webpack://bearbin-moegirlpedia/webpack/runtime/rspack_unique_id","webpack://bearbin-moegirlpedia/./src/utils/api/pageSource.ts","webpack://bearbin-moegirlpedia/./src/gadgets/FileUsedNotLinked/index.ts"],"sourcesContent":["__webpack_require__.rv = () => (\"1.4.2\")","__webpack_require__.ruid = \"bundler=rspack@1.4.2\";\n","import type { ApiQueryResponse } from '@/@types/api';\r\n\r\n/**\r\n * 获取页面源代码\r\n * @param title 页面标题\r\n * @returns 页面源代码\r\n */\r\nconst pageSource = async (title: string, params?: Record<string, any>): Promise<string | undefined> => {\r\n  const api = new mw.Api();\r\n  const res = await api.post({\r\n    action: 'query',\r\n    prop: 'revisions',\r\n    titles: title,\r\n    rvprop: 'content',\r\n    ...params,\r\n  }) as ApiQueryResponse;\r\n  const [pageData] = Object.values(res.query.pages);\r\n  if ('revisions' in pageData) {\r\n    return pageData.revisions?.[0]['*'];\r\n  }\r\n  if ('missing' in pageData) {\r\n    throw ('missingtitle');\r\n  }\r\n};\r\n\r\nexport default pageSource;\r\n","/**\r\n * @description 查询文件非链入使用。\r\n * @todo 标记时跳出窗口可选输入用途\r\n */\r\nimport { pageSource } from '@/utils/api';\r\nimport type { ApiQueryResponse } from \"@/@types/api\";\r\n\r\n$(() => (async () => {\r\n  // 本来想做一个检测当前页面文件存在不存在的，但想了想没啥必要。\r\n  if (mw.config.get('wgNamespaceNumber') === 6) {\r\n    await mw.loader.using(['mediawiki.api', 'mediawiki.ForeignApi', 'mediawiki.notification', 'oojs-ui']);\r\n    const api = new mw.Api();\r\n    const zhmoeApi = new mw.ForeignApi('https://mzh.moegirl.org.cn/api.php');\r\n    const FILENAME = mw.config.get('wgTitle');\r\n    const PAGENAME = mw.config.get('wgPageName');\r\n\r\n    let pageList: string[] = [];\r\n\r\n    // 重定向页面和其他页面元素有所区别，分别处理\r\n    const funlNote = '<div id=\"funl-note\">请注意：对过短的文件名使用本工具可能会出现误判，建议手动检查。</div>';\r\n    if (mw.config.get('wgIsRedirect')) {\r\n      $('.redirectMsg').after('<hr/>', funlNote);\r\n    } else {\r\n      $('#filelinks').after(funlNote);\r\n    }\r\n    // 搜索按钮\r\n    const searchButton = new OO.ui.ButtonWidget({\r\n      label: '查询非链入使用',\r\n      flags: 'progressive',\r\n      icon: 'search',\r\n    });\r\n    const $searchButtonAnchor = searchButton.$element.children('a');\r\n    $('#funl-note').after(searchButton.$element);\r\n\r\n    // 标记非链入使用按钮\r\n    const markButton = new OO.ui.ButtonWidget({\r\n      label: '标记非链入使用',\r\n      flags: 'progressive',\r\n      icon: 'tag',\r\n    });\r\n    const $markButtonLink = markButton.$element.children('a');\r\n    searchButton.$element.after(markButton.$element);\r\n\r\n    // 移除非链入使用标记按钮\r\n    const removeButton = new OO.ui.ButtonWidget({\r\n      label: '移除非链入标记',\r\n      flags: 'progressive',\r\n      icon: 'tag',\r\n    });\r\n    const $removeButtonAnchor = removeButton.$element.children('a');\r\n    markButton.$element.after(removeButton.$element);\r\n\r\n    markButton.$element.hide();\r\n    removeButton.$element.hide();\r\n    removeButton.$element.after(\r\n      '<div id=\"search-result\" style=\"margin:.6em 0\">' +\r\n      '<div id=\"result-overview\"></div>' +\r\n      '<ul id=\"result-list\"></ul>' +\r\n      '</div>' +\r\n      '<hr/>',\r\n    );\r\n\r\n    /**\r\n     * 直接在页面内获取链入使用的列表\r\n     * 最多获取50个，但多于50个的文件根本不需要使用此工具，所以不用考虑这个问题\r\n     * @returns 页面列表\r\n     */\r\n    const usedLinked = () => ($('.mw-gu-onwiki-zh_moegirl_org_cn a') as JQuery<HTMLAnchorElement>).map((_, { text }) => text).get();\r\n\r\n    /**\r\n     * 搜索\r\n     * @param srsearch 搜索文本\r\n     */\r\n    const search = async (srsearch: string) => {\r\n      return await zhmoeApi.get({\r\n        action: 'query',\r\n        list: 'search',\r\n        srnamespace: ['0', '4', '10', '12', '14', '274', '828'],\r\n        srwhat: 'text',\r\n        srprop: 'snippet',\r\n        srsearch,\r\n      }) as ApiQueryResponse;\r\n    };\r\n\r\n    // 搜索\r\n    const searchInSource = async () => {\r\n      // 需要分别搜索未编码和编码后的文件名\r\n      const [decodeSearchResult, encodeSearchResult] = await Promise.all([\r\n        search(`insource:\"${FILENAME.replaceAll('\"', ' ')}\"`), // 文件名可能带有半角双引号，和insource的引号混淆，要替换掉\r\n        search(`insource:\"${encodeURI(FILENAME).replaceAll('\"', ' ').replaceAll('%20', ' ')}\"`),\r\n      ]);\r\n\r\n      const notLinkedList: string[] = [];\r\n      [...encodeSearchResult.query.search!, ...decodeSearchResult.query.search!].forEach((item) => {\r\n        // 通过搜索结果的快照，检查搜索文本内是否有此文件名，用于解决大小写敏感问题\r\n        // 但文件名中的符号可能会影响<span class=\"searchmatch\">的位置插到文件名中间，因此要去掉这对标签\r\n        const snippetTemp = item.snippet.replaceAll('_', ' ').replaceAll('<span class=\"searchmatch\">', '').replaceAll('</span>', '');\r\n        if (\r\n          snippetTemp.includes(FILENAME.replaceAll('_', ' ')) ||\r\n          snippetTemp.includes(encodeURI(FILENAME.replaceAll('_', ' '))) ||\r\n          snippetTemp.includes(encodeURI(FILENAME.replaceAll('_', ' ')).replaceAll('%20', ' '))\r\n        ) {\r\n          notLinkedList.push(item.title); // 合并两个搜索结果并得到页面列表\r\n        }\r\n      });\r\n\r\n      // 排除链入使用的页面\r\n      const used = new Set([...usedLinked()]);\r\n      let filtedPages = notLinkedList.filter((x) => !used.has(x));\r\n\r\n      if (filtedPages.length === 0) {\r\n        $('#result-overview').text('zh站没有查找到非链入使用此文件的页面。');\r\n        return [];\r\n      }\r\n      $('#result-overview').text('文件在以下页面以非内链形式使用：');\r\n\r\n      filtedPages = [...new Set(filtedPages)];\r\n      $('#result-list').append(\r\n        ...filtedPages.map((title) => `<li><a href=\"https://zh.moegirl.org.cn/${title}\">zhmoe:${title}</a></li>`),\r\n      );\r\n      $searchButtonAnchor.removeClass('oo-ui-pendingElement-pending');\r\n      return filtedPages;\r\n    };\r\n\r\n    /** 添加[[T:非链入使用]] */\r\n    const addMark = async () => {\r\n      mw.notify('正在标记……');\r\n      $markButtonLink.addClass('oo-ui-pendingElement-pending');\r\n      const linkList = pageList.map((title) => `[[zhmoe:${title}]]`).join('、'); // 将页面列表写为[[zhmoe:A]]、[[zhmoe:B]]、[[zhmoe:C]]……的形式\r\n      try {\r\n        await api.postWithToken('csrf', {\r\n          format: 'json',\r\n          action: 'edit',\r\n          watchlist: 'nochange',\r\n          tags: 'Automation tool',\r\n          minor: true,\r\n          title: PAGENAME,\r\n          appendtext: `{{非链入使用|${linkList}}}`,\r\n          summary: '标记非链入使用的文件',\r\n        }).done(() => {\r\n          mw.notify('标记成功！将在2秒后刷新……');\r\n          $markButtonLink.removeClass('oo-ui-pendingElement-pending');\r\n          setTimeout(() => {\r\n            window.location.reload();\r\n          }, 2000);\r\n        });\r\n      } catch (err) {\r\n        mw.notify(`标记失败：${err}`, { type: 'error' });\r\n      }\r\n    };\r\n\r\n    /** 移除[[T:非链入使用]] */\r\n    const removeMark = async () => {\r\n      mw.notify('正在移除标记……');\r\n      $removeButtonAnchor.addClass('oo-ui-pendingElement-pending');\r\n      try {\r\n        const source = await pageSource(PAGENAME);\r\n        const replacedSource = source!.replace(/\\{\\{非链入使用\\|[^{}]*\\}\\}/g, ''); // 移除非链入使用模板\r\n        await api.postWithToken('csrf', {\r\n          format: 'json',\r\n          action: 'edit',\r\n          watchlist: 'nochange',\r\n          tags: 'Automation tool',\r\n          minor: true,\r\n          nocreate: true,\r\n          title: PAGENAME,\r\n          text: replacedSource,\r\n          summary: '移除非链入使用标记',\r\n        }).done(() => {\r\n          mw.notify('移除成功！将在2秒后刷新……');\r\n          $removeButtonAnchor.removeClass('oo-ui-pendingElement-pending');\r\n          setTimeout(() => {\r\n            window.location.reload();\r\n          }, 2000);\r\n        });\r\n      } catch (err) {\r\n        mw.notify(`移除失败：${err}`, { type: 'error' });\r\n      }\r\n    };\r\n\r\n    // 执行体\r\n    searchButton.on('click', async () => {\r\n      mw.notify('正在查询……');\r\n      $searchButtonAnchor.addClass('oo-ui-pendingElement-pending');\r\n      pageList = await searchInSource();\r\n      if (pageList.length && $('.used-not-linked').length === 0) {\r\n        markButton.$element.show();\r\n      } else if (pageList.length === 0 && $('.used-not-linked').length) {\r\n        removeButton.$element.show();\r\n      }\r\n      mw.notify('查询完毕');\r\n      $searchButtonAnchor.removeClass('oo-ui-pendingElement-pending');\r\n    });\r\n\r\n    markButton.on('click', addMark);\r\n    removeButton.on('click', removeMark);\r\n  }\r\n})());\r\n"],"names":["pageSource","title","params","api","mw","pageData","Object","res","$","zhmoeApi","FILENAME","PAGENAME","pageList","funlNote","searchButton","OO","$searchButtonAnchor","markButton","$markButtonLink","removeButton","$removeButtonAnchor","search","srsearch","searchInSource","decodeSearchResult","encodeSearchResult","Promise","encodeURI","notLinkedList","item","snippetTemp","used","Set","_","text","filtedPages","x","addMark","linkList","setTimeout","window","err","removeMark","replacedSource","source"],"mappings":"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"}