{"version":3,"file":"VoteRemind.min.js","sources":["webpack://bearbin-moegirlpedia/webpack/runtime/rspack_version","webpack://bearbin-moegirlpedia/webpack/runtime/rspack_unique_id","webpack://bearbin-moegirlpedia/./src/gadgets/VoteRemind/index.js"],"sourcesContent":["__webpack_require__.rv = () => (\"1.4.2\")","__webpack_require__.ruid = \"bundler=rspack@1.4.2\";\n","/**\n * @todo 获取开票时维护组成员\n */\n\n$(() => (async () => {\n  if (!document.getElementsByClassName('votebox')[0] || !(mw.config.get('wgTitle').startsWith('提案/讨论中提案/') || mw.config.get('wgTitle') === '讨论版/权限变更')) {\n    return;\n  }\n  await mw.loader.using(['mediawiki.api', 'mediawiki.util', 'mediawiki.notification', 'oojs-ui', 'ext.gadget.site-lib']);\n  const api = new mw.Api;\n  const $body = $(document.body);\n  const PAGENAME = mw.config.get('wgPageName');\n  const isProposal = mw.config.get('wgTitle').startsWith('提案/讨论中提案/'); // 提案还是人事案\n  const isBot = mw.config.get('wgUserGroups').includes('flood'); // 是否拥有机器用户权限\n  const GadgetTitle = wgULS('一键发送投票提醒', '一鍵發送投票提醒');\n\n  class ReminderWindow extends OO.ui.ProcessDialog {\n    failList = [];\n    static static = {\n      ...super.static,\n      tagName: 'div',\n      name: 'lr-reminder',\n      title: GadgetTitle,\n      actions: [\n        {\n          action: 'cancel',\n          label: '取消',\n          flags: ['safe', 'close', 'destructive'],\n        },\n        {\n          action: 'submit',\n          label: wgULS('发送', '發送'),\n          flags: ['primary', 'progressive'],\n        },\n      ],\n    };\n    constructor(config) {\n      super(config);\n    }\n    initialize() {\n      super.initialize();\n      this.panelLayout = new OO.ui.PanelLayout({\n        scrollable: false,\n        expanded: false,\n        padded: true,\n      });\n\n      // 提案，输入标题\n      this.proposalTitleBox = new OO.ui.TextInputWidget({\n        value: PAGENAME.substring(PAGENAME.lastIndexOf('/') + 1, PAGENAME.length),\n        validate: 'non-empty',\n      });\n      const proposalTitleField = new OO.ui.FieldLayout(this.proposalTitleBox, {\n        label: wgULS('提案标题', '提案標題'),\n        align: 'top',\n      });\n\n      // 人事案，选择章节标题\n      this.headlines = [];\n      for (const item of $('.votebox').parent('.discussionContainer').children('h2').children('.mw-headline')) {\n        this.headlines.push(item.id);\n      }\n      this.sectionTitleDropdown = new OO.ui.DropdownInputWidget({\n        options: [\n          ...this.headlines.map((v) => ({\n            data: v,\n            label: v.replaceAll('_', ' '),\n          })),\n        ],\n      });\n      const sectionTitleFiled = new OO.ui.FieldLayout(this.sectionTitleDropdown, {\n        label: wgULS('人事案标题', '人事案標題'),\n        align: top,\n      });\n\n      // 人事案选择要提醒的用户组\n      this.Papp = new OO.ui.RadioOptionWidget({ data: 'p', label: '管理员、巡查姬', selected: true }); // 管、监、查、行\n      this.Sapp = new OO.ui.RadioOptionWidget({ data: 's', label: '管理员' });\n      this.groupsRadioSelect = new OO.ui.RadioSelectWidget({\n        items: [\n          this.Papp,\n          this.Sapp,\n        ],\n      });\n      const groupsFiled = new OO.ui.FieldLayout(this.groupsRadioSelect, {\n        label: wgULS('要提醒的用户组', '要提醒的用戶組'),\n        align: top,\n      });\n\n      // 提案需标题，人事案需选择标题和要通知的用户组。\n      if (isProposal) {\n        this.panelLayout.$element.append(\n          proposalTitleField.$element,\n        );\n      } else {\n        this.panelLayout.$element.append(\n          sectionTitleFiled.$element,\n          groupsFiled.$element,\n        );\n      }\n      this.$body.append(this.panelLayout.$element);\n    }\n\n    get proposalTitle() {\n      return this.proposalTitleBox.getValue();\n    }\n    get sectionTitle() {\n      return this.sectionTitleDropdown.getValue();\n    }\n    get groupSelected() {\n      return this.groupsRadioSelect.findSelectedItem()?.getData?.();\n    }\n\n    // 获取选择的用户组列表（提案则不选择）\n    async getUserGroup() {\n\n      const userGroup = await api.post({\n        action: 'query',\n        titles: 'Module:UserGroup/data',\n        prop: 'revisions',\n        rvprop: 'content',\n        rvlimit: 1,\n      });\n      const userList = JSON.parse(Object.values(userGroup.query.pages)[0].revisions[0]['*']);\n\n      let groupsToVote;\n      if (isProposal) {\n        groupsToVote = [...userList.sysop, ...userList.patroller];\n      } else {\n        switch (this.groupSelected) {\n          case 'p':\n            groupsToVote = [...userList.sysop, ...userList.patroller];\n            break;\n          case 's':\n            groupsToVote = userList.sysop;\n            break;\n        }\n      }\n      return groupsToVote;\n    }\n\n    // 获取已投票用户列表\n    get userVoted() {\n      let hrefList;\n      if (isProposal) {\n        // 提案检测.votebox后面的<ol>内的用户链接\n        hrefList = $('.votebox ~ ol a[href^=\"/User\"], .votebox ~ ol a[href^=\"/index.php?title=User\"]')\n          .map((_, { href }) => href)\n          .get();\n      } else {\n        // 人事案检测当前选择标题所在.discussionContainer内.votebox后面的ol\n        hrefList = $(`#${this.sectionTitle.replaceAll(':', '\\\\:')}`)\n          .parents('.discussionContainer')\n          .find('.votebox ~ ol a[href^=\"/User\"], .votebox ~ ol a[href^=\"/index.php?title=User\"]')\n          .map((_, { href }) => href)\n          .get();\n      }\n      return hrefList.map((item) => decodeURI(item.replace(/.*User(_talk)?:([^&]*).*/g, '$2')));\n    }\n\n    // 根据选择的用户组，去掉已投票用户和不愿收到提醒用户，得到要提醒的用户列表\n    async getUserToRemind() {\n      let userToRemind;\n      await this.getUserGroup().then((result) => {\n        userToRemind = result;\n      });\n\n      const Noremind = await api.post({\n        action: 'query',\n        titles: 'User:BearBin/js/voteRemind.js/Noremind',\n        prop: 'revisions',\n        rvprop: 'content',\n        rvlimit: 1,\n      });\n      const userNoremind = Object.values(Noremind.query.pages)[0].revisions[0]['*'].split(/\\n\\* */);\n      let applicant;\n      if (!isProposal) {\n        applicant = this.sectionTitle.replace(/.*User:(.*)/g, '$1').replaceAll('_', ' ');\n      }\n      const userExcluded = new Set([...this.userVoted, ...userNoremind, ...[applicant]]);\n      return userToRemind.filter((x) => !userExcluded.has(x));\n    }\n\n    // 生成链接\n    get link() {\n      if (isProposal) {\n        return `[[萌娘百科_talk:提案/讨论中提案/${this.proposalTitle}|${this.proposalTitle.replaceAll('_', ' ')}]]`;\n      }\n      return `[[萌娘百科_talk:讨论版/权限变更#${this.sectionTitle}|${this.sectionTitle.replaceAll('_', ' ')}]]`;\n    }\n\n    // 发送提醒\n    async remind(username) {\n      const send = await api.postWithToken('csrf', {\n        format: 'json',\n        action: 'edit',\n        section: 'new',\n        watchlist: 'nochange',\n        tags: 'Automation tool',\n        bot: isBot,\n        title: `User_talk:${username}`,\n        sectiontitle: '投票提醒',\n        text: `<i style=\"font-size:small\">本通知使用一键提醒小工具发出，如出现错误，请联系[[User_talk:BearBin|BearBin]]。若不希望接到此提醒，请在[[User:BearBin/js/voteRemind.js/Noremind|这个页面]]记录您的用户名。</i><br/>您好，${isProposal ? '提案' : '人事案'}【${this.link}】已经开始投票。您尚未投票，请及时参与喵～——~~~~`,\n      }).done(() => {\n        mw.notify(wgULS(`向${username}发送投票提醒成功。`, `向${username}發送投票提醒成功。`));\n      });\n      if (send.error) {\n        this.failList.push(username);\n        mw.notify(wgULS(`向${username}发送投票提醒失败：${send.error.code}。`, `向${username}發送投票提醒失敗：${send.error.code}。`), { type: 'error' });\n      }\n    }\n\n    getActionProcess(action) {\n      if (action === 'cancel') {\n        return new OO.ui.Process(() => {\n          this.close({ action });\n        }, this);\n      } else if (action === 'submit') {\n        return new OO.ui.Process($.when((async () => {\n          this.failList = []; // 清空失败列表（真的有必要吗（））\n          await this.getUserToRemind().then(async (result) => {\n            for (const user of result) {\n              await this.remind(user);\n            }\n          });\n          if (this.failList.length > 0) {\n            oouiDialog.alert(this.failList.join('、'), {\n              title: wgULS('向以下用户发送提醒失败', '向以下使用者發送提醒失敗'),\n              size: 'small',\n            });\n          }\n          this.close({ action });\n        })()).promise(), this);\n      }\n      return super.getActionProcess(action);\n    }\n  }\n\n  // 添加按钮和窗口\n  const windowManager = new OO.ui.WindowManager();\n  $body.append(windowManager.$element);\n  const reminderDialog = new ReminderWindow({\n    size: 'medium',\n    id: 'bearbin-vote-remind',\n  });\n  windowManager.addWindows([reminderDialog]);\n\n  $(mw.util.addPortletLink('p-cactions', 'javascript:void(0)', '投票提醒', 'ca-vote-remind', GadgetTitle, 'r')).on('click', (e) => {\n    e.preventDefault();\n    windowManager.openWindow(reminderDialog);\n    $body.css('overflow', 'auto');\n  });\n})());\n"],"names":["$","document","mw","api","$body","PAGENAME","isProposal","isBot","GadgetTitle","wgULS","ReminderWindow","OO","config","proposalTitleField","item","v","sectionTitleFiled","top","groupsFiled","groupsToVote","userList","JSON","Object","userGroup","hrefList","_","href","decodeURI","userToRemind","applicant","result","userNoremind","Noremind","userExcluded","Set","x","username","send","action","user","oouiDialog","windowManager","reminderDialog","e"],"mappings":"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"}