(()=>{"use strict";const t=function(t,e,n){var r=-1,o=t.length;e<0&&(e=-e>o?0:o+e),(n=n>o?o:n)<0&&(n+=o),o=e>n?0:n-e>>>0,e>>>=0;for(var a=Array(o);++r<o;)a[r]=t[r+e];return a};const e=function(t,e){return t===e||t!=t&&e!=e};const n="object"==typeof global&&global&&global.Object===Object&&global;var r="object"==typeof self&&self&&self.Object===Object&&self;const o=(n||r||Function("return this")()).Symbol;var a=Object.prototype,i=a.hasOwnProperty,s=a.toString,c=o?o.toStringTag:void 0;const l=function(t){var e=i.call(t,c),n=t[c];try{t[c]=void 0;var r=!0}catch(t){}var o=s.call(t);return r&&(e?t[c]=n:delete t[c]),o};var u=Object.prototype.toString;const f=function(t){return u.call(t)};var b=o?o.toStringTag:void 0;const p=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":b&&b in Object(t)?l(t):f(t)};const m=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)};const d=function(t){if(!m(t))return!1;var e=p(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e};const g=function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991};const y=function(t){return null!=t&&g(t.length)&&!d(t)};var h=/^(?:0|[1-9]\d*)$/;const w=function(t,e){var n=typeof t;return!!(e=null==e?9007199254740991:e)&&("number"==n||"symbol"!=n&&h.test(t))&&t>-1&&t%1==0&&t<e};const v=function(t,n,r){if(!m(r))return!1;var o=typeof n;return!!("number"==o?y(r)&&w(n,r.length):"string"==o&&n in r)&&e(r[n],t)};var j=/\s/;const x=function(t){for(var e=t.length;e--&&j.test(t.charAt(e)););return e};var N=/^\s+/;const O=function(t){return t?t.slice(0,x(t)+1).replace(N,""):t};const B=function(t){return null!=t&&"object"==typeof t};const q=function(t){return"symbol"==typeof t||B(t)&&"[object Symbol]"==p(t)};var D=/^[-+]0x[0-9a-f]+$/i,T=/^0b[01]+$/i,V=/^0o[0-7]+$/i,k=parseInt;const H=function(t){if("number"==typeof t)return t;if(q(t))return NaN;if(m(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=m(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=O(t);var n=T.test(t);return n||V.test(t)?k(t.slice(2),n?2:8):D.test(t)?NaN:+t};var A=1/0;const S=function(t){return t?(t=H(t))===A||t===-1/0?17976931348623157e292*(t<0?-1:1):t==t?t:0:0===t?t:0};const U=function(t){var e=S(t),n=e%1;return e==e?n?e-n:e:0};var F=Math.ceil,C=Math.max;const G=function(e,n,r){n=(r?v(e,n,r):void 0===n)?1:C(U(n),0);var o=null==e?0:e.length;if(!o||n<1)return[];for(var a=0,i=0,s=Array(F(o/n));a<o;)s[i++]=t(e,a,a+=n);return s},M=async(t,e=["page","subcat","file"])=>{const n=new mw.Api,r=[];if(mw.config.get("wgUserGroups").some((t=>["bot","flood","patroller","sysop"].includes(t)))){let o="";for(;void 0!==o;){const a=await n.post({action:"query",format:"json",utf8:!0,list:"categorymembers",cmlimit:"max",cmtitle:t,cmprop:"title",cmtype:e,cmcontinue:o});a.query.categorymembers[0]&&r.push(...a.query.categorymembers.map((({title:t})=>t))),o=a.continue?.cmcontinue}}else{const n=async t=>{const o=$(await $.ajax(t)),a=e.map((t=>{switch(t){case"page":return"#mw-pages li a";case"subcat":return"#mw-subcategories li a";case"file":return"#mw-category-media li a.galleryfilename"}})).join(","),i=o.find(a).map(((t,e)=>e.classList.contains("CategoryTreeLabel")?`Category:${$(e).text()}`:e.classList.contains("galleryfilename")?`File:${$(e).text()}`:$(e).text())).get();if(r.push(...i),e.includes("page")){const t=o.find('a[href*="&pagefrom="]');t.length&&await n(t.eq(0).attr("href"))}if(e.includes("subcat")){const t=o.find('a[href*="&subcatfrom="]');t.length&&await n(t.eq(0).attr("href"))}if(e.includes("file")){const t=o.find('a[href*="&filefrom="]');t.length&&await n(t.eq(0).attr("href"))}};await n(`/${t}?useskin=vector&safemode=1`)}return r},Y=({text:t=""})=>{$(document.head).append($('<style id="bearbintool-headerbutton-style">#firstHeading:has(.bearbintool-headerbutton-wrapper){align-items:center;display:flex;flex-wrap:wrap;justify-content:space-between}#firstHeading:has(.bearbintool-headerbutton-wrapper) .bearbintool-headerbutton-wrapper{display:flex;gap:6px}#firstHeading:has(.bearbintool-headerbutton-wrapper) .bearbintool-headerbutton-wrapper .bearbintool-headerbutton{background-color:#fff;border:1px solid #aaa;border-radius:0;cursor:pointer;font-size:16px;padding:4px 8px;transition:background-color .2s ease-out}#firstHeading:has(.bearbintool-headerbutton-wrapper) .bearbintool-headerbutton-wrapper .bearbintool-headerbutton:hover{background-color:#eee}</style>'));let e=$(".bearbintool-headerbutton-wrapper");$(".bearbintool-headerbutton-wrapper").length<1&&(e=$('<div class="bearbintool-headerbutton-wrapper"></div>'),$("#firstHeading").append(e));const n=$(`<button class="bearbintool-headerbutton">${t}</button>`);return e.append(n),n};$((()=>{const t=new mw.Api;if("User:BearBin/VNData/Galgame声优更新时间"===mw.config.get("wgPageName")){mw.loader.using(["moment","mediawiki.notification"]);const e=Y({text:"更新"});e.on("click",(async()=>{try{if("正在更新……"===e.text())return;e.text("正在更新……");const n=await M("Category:R-18作品声优"),r=G(n,50),o=[];for(const e of r){const n=await t.post({action:"query",format:"json",prop:"revisions",titles:e.join("|"),rvprop:"timestamp"});o.push(...Object.values(n.query.pages).map((({title:t,revisions:[{timestamp:e}]})=>({title:t,timestamp:e}))))}const a=o.sort(((t,e)=>new Date(t.timestamp)<new Date(e.timestamp)?-1:1)).map((({title:t,timestamp:e})=>`* [[${t}]]：${moment(e).format("YYYY-MM-DD HH:mm:ss")}`)).join("\n");await t.postWithToken("csrf",{action:"edit",title:"User:BearBin/VNData/Galgame声优更新时间",text:["本页面统计[[:Category:R-18作品声优]]内页面的最后更新时间，提示可能需要更新的页面。\n","您可以使用[[User:BearBin/VNData#VNTools|VNTools]]更新本页面。\n",a].join("\n"),summary:"使用[[User:BearBin/VNData#VNTools|VNTools]]自动更新列表",bot:!0,tags:"Bot"}),e.text("更新成功！"),mw.notify("更新成功！即将刷新页面……"),window.location.reload()}catch(t){mw.notify(`更新失败！${t}`,{type:"error"}),e.text("更新")}}))}}))})();