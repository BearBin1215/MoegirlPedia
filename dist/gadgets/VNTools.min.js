(()=>{"use strict";const t=({text:t=""})=>{$(document.head).append($('<style id="bearbintool-headerbutton-style">#firstHeading:has(.bearbintool-headerbutton-wrapper){align-items:center;display:flex;flex-wrap:wrap;justify-content:space-between}#firstHeading:has(.bearbintool-headerbutton-wrapper) .bearbintool-headerbutton-wrapper{display:flex;gap:6px}#firstHeading:has(.bearbintool-headerbutton-wrapper) .bearbintool-headerbutton-wrapper .bearbintool-headerbutton{background-color:#fff;border:1px solid #aaa;border-radius:0;cursor:pointer;font-size:16px;padding:4px 8px;transition:background-color .2s ease-out}#firstHeading:has(.bearbintool-headerbutton-wrapper) .bearbintool-headerbutton-wrapper .bearbintool-headerbutton:hover{background-color:#eee}</style>'));let e=$(".bearbintool-headerbutton-wrapper");$(".bearbintool-headerbutton-wrapper").length<1&&(e=$('<div class="bearbintool-headerbutton-wrapper"></div>'),$("#firstHeading").append(e));const n=$(`<button class="bearbintool-headerbutton">${t}</button>`);return e.append(n),n};const e=function(t,e,n){var o=-1,r=t.length;e<0&&(e=-e>r?0:r+e),(n=n>r?r:n)<0&&(n+=r),r=e>n?0:n-e>>>0,e>>>=0;for(var a=Array(r);++o<r;)a[o]=t[o+e];return a};const n=function(t,e){return t===e||t!=t&&e!=e};const o="object"==typeof global&&global&&global.Object===Object&&global;var r="object"==typeof self&&self&&self.Object===Object&&self;const a=(o||r||Function("return this")()).Symbol;var i=Object.prototype,s=i.hasOwnProperty,c=i.toString,l=a?a.toStringTag:void 0;const u=function(t){var e=s.call(t,l),n=t[l];try{t[l]=void 0;var o=!0}catch(t){}var r=c.call(t);return o&&(e?t[l]=n:delete t[l]),r};var p=Object.prototype.toString;const f=function(t){return p.call(t)};var m=a?a.toStringTag:void 0;const b=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":m&&m in Object(t)?u(t):f(t)};const d=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)};const g=function(t){if(!d(t))return!1;var e=b(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e};const y=function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991};const w=function(t){return null!=t&&y(t.length)&&!g(t)};var h=/^(?:0|[1-9]\d*)$/;const v=function(t,e){var n=typeof t;return!!(e=null==e?9007199254740991:e)&&("number"==n||"symbol"!=n&&h.test(t))&&t>-1&&t%1==0&&t<e};const j=function(t,e,o){if(!d(o))return!1;var r=typeof e;return!!("number"==r?w(o)&&v(e,o.length):"string"==r&&e in o)&&n(o[e],t)};var x=/\s/;const N=function(t){for(var e=t.length;e--&&x.test(t.charAt(e)););return e};var T=/^\s+/;const k=function(t){return t?t.slice(0,N(t)+1).replace(T,""):t};const q=function(t){return null!=t&&"object"==typeof t};const B=function(t){return"symbol"==typeof t||q(t)&&"[object Symbol]"==b(t)};var O=/^[-+]0x[0-9a-f]+$/i,V=/^0b[01]+$/i,U=/^0o[0-7]+$/i,D=parseInt;const A=function(t){if("number"==typeof t)return t;if(B(t))return NaN;if(d(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=d(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=k(t);var n=V.test(t);return n||U.test(t)?D(t.slice(2),n?2:8):O.test(t)?NaN:+t};var H=1/0;const S=function(t){return t?(t=A(t))===H||t===-1/0?17976931348623157e292*(t<0?-1:1):t==t?t:0:0===t?t:0};const C=function(t){var e=S(t),n=e%1;return e==e?n?e-n:e:0};var F=Math.ceil,G=Math.max;const M=function(t,n,o){n=(o?j(t,n,o):void 0===n)?1:G(C(n),0);var r=null==t?0:t.length;if(!r||n<1)return[];for(var a=0,i=0,s=Array(F(r/n));a<r;)s[i++]=e(t,a,a+=n);return s},P=async(t,e=["page","subcat","file"])=>{const n=new mw.Api,o=[];if(mw.config.get("wgUserGroups").some((t=>["bot","flood","patroller","sysop"].includes(t)))){let r="";for(;void 0!==r;){const a=await n.post({action:"query",format:"json",utf8:!0,list:"categorymembers",cmlimit:"max",cmtitle:t,cmprop:"title",cmtype:e,cmcontinue:r});a.query.categorymembers[0]&&o.push(...a.query.categorymembers.map((({title:t})=>t))),r=a.continue?.cmcontinue}}else{const n=async t=>{const r=$(await $.ajax(t)),a=e.map((t=>{switch(t){case"page":return"#mw-pages li a";case"subcat":return"#mw-subcategories li a";case"file":return"#mw-category-media li a.galleryfilename"}})).join(","),i=r.find(a).map(((t,e)=>e.classList.contains("CategoryTreeLabel")?`Category:${$(e).text()}`:e.classList.contains("galleryfilename")?`File:${$(e).text()}`:$(e).text())).get();if(o.push(...i),e.includes("page")){const t=r.find('a[href*="&pagefrom="]');t.length&&await n(t.eq(0).attr("href"))}if(e.includes("subcat")){const t=r.find('a[href*="&subcatfrom="]');t.length&&await n(t.eq(0).attr("href"))}if(e.includes("file")){const t=r.find('a[href*="&filefrom="]');t.length&&await n(t.eq(0).attr("href"))}};await n(`/${t}?useskin=vector&safemode=1`)}return o},Y=async(t,e)=>{const n=new mw.Api,o=await n.post({action:"query",prop:"revisions",titles:t,rvprop:"content",...e}),[r]=Object.values(o.query.pages);if("revisions"in r)return r.revisions?.[0]["*"];if("missing"in r)throw"missingtitle"},L=new mw.Api,R=mw.config.get("wgUserGroups").some((t=>["bot","flood","sysop"].includes(t)))?500:50,W=async()=>{const t=t=>t.map((({username:t,nickname:e,subscript:n})=>`{{User|${t}${e?`|${e}`:""}}}${n||""}`)).join(" • \x3c!--\n    --\x3e"),e=await Y("Template:萌百视觉小说研究会"),n=(t=>t.replace(/.*<!-- *列表起点 *-->(.*)<!-- *列表终点 *-->.*/gs,"$1").replace(/<!--[\s\S]*?-->/g,"").replace(/\* */g,"").trim().split("\n").map((t=>{const e=t.trim().match(/^([^<(]*)(\(([^)]*)\))?(<.*>)?$/);return{username:e[1],nickname:e[3],subscript:e[4]}})))(e),o=await(async t=>{const e={},n=M(t,R);for(const t of n){const{query:{users:n}}=await L.post({action:"query",list:"users",ususers:t.join("|"),usprop:"groups"});n.forEach((({name:t,groups:n})=>{e[t]=n}))}return e})(n.map((({username:t})=>t))),r={maintainer:[],autopatrolled:[],autoconfirmed:[]};for(const t of n){const e=o[(t.username.charAt(0).toUpperCase()+t.username.slice(1)).replace("_"," ")];e.some((t=>["sysop","patroller"].includes(t)))?r.maintainer.push(t):e.some((t=>["goodeditor","honoredmaintainer"].includes(t)))?r.autopatrolled.push(t):r.autoconfirmed.push(t)}const a=e.replace(/(<!-- *维护人员 *-->).*(<!-- *维护人员 *-->)/gs,`$1${t(r.maintainer)}$2`).replace(/(<!-- *优编荣维 *-->).*(<!-- *优编荣维 *-->)/gs,`$1${t(r.autopatrolled)}$2`).replace(/(<!-- *自确 *-->).*(<!-- *自确 *-->)/gs,`$1${t(r.autoconfirmed)}$2`);a===e?mw.notify("用户组信息无变化",{type:"info"}):(await(async t=>{await L.postWithToken("csrf",{action:"edit",title:"Template:萌百视觉小说研究会",summary:"使用[[User:BearBin/VNData#VNTools|VNTools]]自动更新用户组信息",text:t,bot:!0,tags:"Bot"})})(a),mw.notify("更新成功！即将刷新页面……"),window.location.reload())};$((()=>{if(mw.loader.using(["mediawiki.notification","mediawiki.api"]),"User:BearBin/VNData/Galgame声优更新时间"===mw.config.get("wgPageName")){mw.loader.using(["moment"]);const e=t({text:"更新"});e.on("click",(async()=>{try{if("正在更新……"===e.text())return;e.text("正在更新……"),await(async()=>{const t=await P("Category:R-18作品声优"),e=M(t,R),n=[];for(const t of e){const e=await L.post({action:"query",format:"json",prop:"revisions",titles:t.join("|"),rvprop:"timestamp"});n.push(...Object.values(e.query.pages).map((({title:t,revisions:[{timestamp:e}]})=>({title:t,timestamp:e}))))}const o=n.sort(((t,e)=>new Date(t.timestamp)<new Date(e.timestamp)?-1:1)).map((({title:t,timestamp:e})=>`* [[${t}]]：${moment(e).format("YYYY-MM-DD HH:mm:ss")}`)).join("\n");await L.postWithToken("csrf",{action:"edit",title:"User:BearBin/VNData/Galgame声优更新时间",text:["本页面统计[[:Category:R-18作品声优]]内页面的最后更新时间，提示可能需要更新的页面。\n","您可以使用[[User:BearBin/VNData#VNTools|VNTools]]更新本页面。\n",o].join("\n"),summary:"使用[[User:BearBin/VNData#VNTools|VNTools]]自动更新列表",bot:!0,tags:"Bot"}),mw.notify("更新成功！即将刷新页面……"),window.location.reload()})()}catch(t){mw.notify(`更新失败：${t}`,{type:"error"}),e.text("更新")}}))}if("Template:萌百视觉小说研究会"===mw.config.get("wgPageName")){const e=t({text:"更新"});e.on("click",(async()=>{try{if("正在更新……"===e.text())return;e.text("正在更新……"),await W()}catch(t){mw.notify(`更新失败：${t}`,{type:"error"}),e.text("更新")}}))}}))})();