(()=>{"use strict";const e=e=>new Promise(t=>setTimeout(t,e)),t=async(e,t=["page","subcat","file"])=>{const i=new mw.Api,o=[];if(mw.config.get("wgUserGroups").some(e=>["bot","flood","patroller","sysop"].includes(e))){let a="";for(;void 0!==a;){const n=await i.post({action:"query",format:"json",utf8:!0,list:"categorymembers",cmlimit:"max",cmtitle:e,cmprop:"title",cmtype:t,cmcontinue:a});n.query.categorymembers[0]&&o.push(...n.query.categorymembers.map(({title:e})=>e)),a=n.continue?.cmcontinue}}else{const i=async e=>{const a=$(await $.ajax(e)),n=t.map(e=>{switch(e){case"page":return"#mw-pages li a";case"subcat":return"#mw-subcategories li a";case"file":return"#mw-category-media li a.galleryfilename"}}).join(","),s=a.find(n).map((e,t)=>t.classList.contains("CategoryTreeLabel")?`Category:${$(t).text()}`:t.classList.contains("galleryfilename")?`File:${$(t).text()}`:$(t).text()).get();if(o.push(...s),t.includes("page")){const e=a.find('a[href*="&pagefrom="]');e.length&&await i(e.eq(0).attr("href"))}if(t.includes("subcat")){const e=a.find('a[href*="&subcatfrom="]');e.length&&await i(e.eq(0).attr("href"))}if(t.includes("file")){const e=a.find('a[href*="&filefrom="]');e.length&&await i(e.eq(0).attr("href"))}};await i(`/${e}?useskin=vector&safemode=1`)}return o};$(()=>(async()=>{await mw.loader.using(["mediawiki.api"]);const i=new class{data;constructor(e){this.data=e}addPageToList(e,t){const i=[{obj:this.data,path:[]}];for(;i.length>0;){const{obj:o,path:a}=i.shift();for(const[n,s]of Object.entries(o)){if(n===e)return Array.isArray(s)?void s.push(t):void console.error(`${e}不是数组。`);"object"==typeof s&&null!==s&&i.push({obj:s,path:[...a,n]})}}this.data[e]=[t]}get wikitext(){let e=1;const t=["本页面由机器人自动更新，因此通常不建议直接编辑本页面。","","最后更新时间：<u>~~~~~</u>，约15分钟误差。","","大多数内容建议手动排查，以免误判。","","一些常见误判诸如在非页顶使用{{tl|dablink}}等情况。若出现其他误判，请[[User_talk:BearBin|联系阿熊]]。","{{目录右置}}"],i=o=>{e++;for(const[a,n]of Object.entries(o))if(t.push("",`${"=".repeat(e)} ${a} ${"=".repeat(e)}`),Array.isArray(n))n.length>0?t.push("{{hide|1=点击展开列表|2=",...n.map(e=>"string"==typeof e?`*[[${e}]]`:`*-{[[${e[0]}]]}-：${e[1]}`),"}}"):t.push("暂无");else{if("object"!=typeof n||null===n)throw new Error(`${a}对应值类型有误: ${typeof n}`);i(n)}e--};return i(this.data),t.join("\n")}}({消歧义页使用管道符:{后缀:[],前缀:[]},疑似繁体页面名:[],不礼貌排版习惯:{连续换行:[],"big地狱（5个以上）":[],疑似大家族前单独用二级标题:[],疑似喊话:[]},弃用标签:{center:[],strike:[],tt:[],font:[]},能用内链非要外链:[],不符合模板规范:{重复TOP:[],页顶用图超过99px:{条目:[],模板:[]},顶部模板排序:[],注释和外部链接后的大家族模板:[]},大家族name参数有误:[],模板多余换行:{两个或以上:[],一个:[]},"“•”左右少空格":{左侧缺少:[],右侧缺少:[]},"管道符前后一致（无明显影响，通常不用专门处理）":{"<nowiki>[[ABC|ABC]]</nowiki>":[],"<nowiki>|ABC{{!}}ABC</nowiki>":[]},旧声优分类格式:[],"http(s)少冒号或斜杠":[]}),o={prefix:"\\{\\{(?:template:|[模样樣]板:|T:)?",navbar:["小[导導]航[条條]","小[导導]航[条條]\\/承前[启啟][后後]"],disambigTop:["about","not","distinguish","dablink","redirectHere","otheruseslist"],top:["[欢歡]迎[编編][辑輯]","不完整","急需改[进進]","[^{|\\[\\]]+top"],disambig:["消歧[义義]"],note:["[现現][实實]人物"],warn:["法律声明","医学声明","学术提示","非官方猜测","易引发谣言","用梗适度","谨慎使用"],otherNote:["已故现实人物","已完结","长期关注及更新","含时长期关注及更新","停止活动","引退"],amuse:["阿卡林","被巡回","黑幕可能无法划开","暂时保留","一本正经地胡说八道","坑"],quote:["cquote","先一起喊"],bottom:["reflist","notelist","NoteFoot","notes","cite","到萌娘文[库庫]","到[维維]基百科","ToWikipedia","到FANDOM","到纳木维基","到VNDB","To BWIKI","To 52poke Wiki","To Megami Tensei Wiki","到灰[机機]wiki","到泰拉瑞[亚亞]Wiki","到泰拉瑞亚MODWiki","到MC百科","到Minecraft Wiki","到魔禁[维維]基","到THBWiki","到BlitzHanger","到女神[转轉]生[维維]基","To Megami Tensei Wiki","到MLP中文[维維]基","到PvZ Wiki","微博","PAGENAME","DEFAULTSORT","#if","#switch","lj\\|","color\\|","ruby\\|","hide\\|","[剧劇]透","黑幕","胡话","jk\\|","main\\|","ja\\}","en\\}","zh\\}","zh-hans","zh-hant","lang\\|","cquote","Ps\\|","catn","ColonSort","bilibiliVideo","BV","YoukuVideo","music163","背景[图圖]片","替[换換][侧側][边邊][栏欄]底[图圖]","外部[图圖]片注[释釋]","[标標][题題]替[换換]","PicHover","Outer[ _]image","pic\\|","disambig","Playlist","消歧义页","NoSubpage","noReferer","用梗适度","一本正经地胡说八道","color[ _]block","RoundTop","see also"]};let a;const n=(e,...t)=>((e,t)=>{let i;const o=[];for(;null!==(i=t.exec(e));)o.push(i.index);return o})(e,new RegExp(`${o.prefix}(${t.join("|")})[}\\|\\n]`,"gi")),s=(e,t,o)=>{if(t.includes("Category:消歧义页")){const t=e.match(/\[\[(.+)\(.+\)\|\1\]\].*—/),a=e.match(/\[\[[^:\n].*:(.+)\|\1\]\].*—/);t?i.addPageToList("后缀",[o,`<code><nowiki>${t[0].replaceAll("—","")}</nowiki></code>`]):a&&i.addPageToList("前缀",[o,`<code><nowiki>${a[0].replaceAll("—","")}</nowiki></code>`])}},r=(e,t,o)=>{t.some(e=>e.includes("音乐作品"))||(/(<br *\/ *>\s*){4,}/i.test(e)||/(\n|<br *\/? *>){8}/i.test(e))&&i.addPageToList("连续换行",o)},c=(e,t,o)=>{/(<big>){5}/i.test(e)&&i.addPageToList("big地狱（5个以上）",o)},l=(e,t,a)=>{new RegExp(`${o.prefix}(背景[图圖]片|替[换換][侧側][边邊][栏欄]底[图圖])[^}]+img\\.moegirl\\.org\\.cn`,"si").test(e)&&"Deltarune/黑暗世界"!==a&&i.addPageToList("能用内链非要外链",a)},g=(e,t,a)=>{new RegExp(`== *(相关|更多|其他|其它)(条目|條目|内容|链接)? *==\n*${o.prefix}((?!${o.bottom.join("|")}).)*\\}`,"gi").test(e)&&i.addPageToList("疑似大家族前单独用二级标题",a)},d=(e,t,a)=>{new RegExp(`== *(脚注|[注註]解|注释|註釋|外部[链鏈]接|外部連結|外链|[参參]考).*==[\\s\\S]*\n${o.prefix}((?!${o.bottom.join("|")}).)*\\}`,"gi").test(e)&&i.addPageToList("注释和外部链接后的大家族模板",a)},p=(e,t,o)=>{(/\{\{color\|red\|'''[^}|]{50,}'''\}\}/i.test(e)||/'''\{\{color\|red\|[^}|]{50,}\}\}'''/i.test(e))&&i.addPageToList("疑似喊话",o)},u=(e,t,n)=>{const s=new RegExp(`${o.prefix}(${o.top.join("|")})[}\\|\\n]`,"gi"),r=e.match(s)||[];let c=0;for(const e of r)a.includes(e.replace(s,"$1"))&&c++;c>1&&i.addPageToList("重复TOP",n)},m=(e,t,o)=>{(/leftimage *=[.\n]*\d{3}px/.test(e)||/\{\{(?:template:|[模样樣]板:|T:)?(欢迎编辑|歡迎編輯|不完整|customtop).*\d{3}px/i.test(e))&&i.addPageToList("条目",o)},f=(e,t,a)=>{const s={消歧义导航模板:n(e,...o.disambigTop),专题导航导航:n(e,"导航"),导航条:n(e,...o.navbar),"{{tl|消歧义}}":n(e,...o.disambig),欢迎编辑或专题TOP:n(e,...o.top),提示模板:n(e,...o.note),娱乐模板:n(e,...o.amuse),喊话模板:n(e,...o.quote)},r=(e=>{for(let t=0;t<e.length-1;t++){const i=Math.max(...e[t].filter(e=>e<=600));for(let o=t+1;o<e.length;o++)if(i>=Math.min(...e[o].filter(e=>e<=600)))return o}return 0})(Object.values(s));r>0&&i.addPageToList("顶部模板排序",[a,`<code>${Object.keys(s)[r]}</code>`])},w=(e,t,o)=>{t.includes("Category:页顶提示模板")&&(/leftimage *=.*\d{3}px/.test(e)||/(width|size) *= *\d{3}px/.test(e)||/\[\[(File|Image):[^\]]+\| *\d{3}px/i.test(e))&&i.addPageToList("模板",o)},h=(e,t,o)=>{t.some(e=>["Category:模板文档","Category:条目格式模板","Category:权限申请模板"].includes(e))||(/(\n{2,}<noinclude>|<\/noinclude>\n{2,}[^|]|<includeonly>\n{2,}|\n{2,}<\/includeonly>)/.test(e)?i.addPageToList("两个或以上",o):/(\n<noinclude>|<\/noinclude>\n|<includeonly>\n|\n<\/includeonly>)/.test(e)&&i.addPageToList("一个",o))},k=(e,t,o)=>{if(t.includes("Category:用户编辑组模板"))return;const a=e.match(/([^\]\n]+\]\]|[^}\n]+\}\})•/),n=e.match(/•(\[\[[^\]\n]+|\{\{[^}\n]+)/);a&&i.addPageToList("左侧缺少",[o,`<code><nowiki>${a[0]}</nowiki></code>`]),n&&i.addPageToList("右侧缺少",[o,`<code><nowiki>${n[0]}</nowiki></code>`])},y=(e,t,o)=>{const a=e.match(/\[\[ *([^\]]+) *\| *\1 *\]\]/),n=e.match(/\| *([^\]{}}]+) *\{\{!\}\} *\1 *(\||\})/);a&&i.addPageToList("<nowiki>[[ABC|ABC]]</nowiki>",[o,`<code><nowiki>${a[0]}</nowiki></code>`]),n&&i.addPageToList("<nowiki>|ABC{{!}}ABC</nowiki>",[o,`<code><nowiki>${n[0]}</nowiki></code>`])},b=(e,t,o)=>{const a=e.match(/\|多位(配音|声优) *= *\{\{cate\|[^{}|]+\|[^{}[\]\n]+[^色{}[\]\n](\}\}|\|)/gi);a&&i.addPageToList("旧声优分类格式",[o,`<code><nowiki>${a[0]}</nowiki></code>`])},$=(e,t,o)=>{const a=e.match(/\| *name *= *[^|\n]*/gi)||[];if(!t.includes("Category:模板文档")&&e.match(/\{\{ *(?:#invoke:|Template:|T:|模板:|样板:)? *(大家族|Nav)/gi)&&!/:(沙盒|Sandbox|Navbox|大家族$)/.test(o)&&a)for(const e of a)if(e.replace(/\| *name *= *([^|\n]*)/g,"$1").replaceAll("_"," ").trim().toLowerCase()!==o.replace("Template:","").toLowerCase())return void i.addPageToList("大家族name参数有误",[o,`<code><nowiki>${e}</nowiki></code>`])},T=(e,t,o)=>{const a=e.match(/[^/]https?(\/\/|:\/[a-zA-Z0-9])/gi);a&&i.addPageToList("http(s)少冒号或斜杠",[o,`<code><nowiki>${a[0]}</nowiki></code>`])},x=(e,t,o)=>{const a=[{tag:"center",regex:/<(center)(?:\s[^>]*)?>|<\/center>/gi},{tag:"tt",regex:/<(tt)(?:\s[^>]*)?>|<\/tt>/gi},{tag:"strike",regex:/<(strike)(?:\s[^>]*)?>|<\/strike>/gi},{tag:"font",regex:/<(font)(?:\s[^>]*)?>|<\/font>/gi}];for(const{tag:t,regex:n}of a){const a=e.match(n);a&&i.addPageToList(t,[o,`<code><nowiki>${a[0]}</nowiki></code>`])}},P=new mw.Api,L=async(t,i=0,o=10,a=500)=>{let n={},s=!1;const r=e=>{for(const{title:t,revisions:i,categories:o}of e)n[t]||={categories:[],text:i?.[0]?.["*"]?.replace(/<!--[\s\S]*?-->/g,"")||""},i?.length>0&&0,o&&n[t].categories.push(...o.map(e=>e.title))},c={action:"query",generator:"allpages",gaplimit:a,cllimit:"max",gapnamespace:i,prop:"revisions|categories",rvprop:"content",utf8:!0},l=async(t,i)=>{s||(s=!0),console.error(`请求出错：${t}，请求参数：${JSON.stringify(c)}，即将重试(${i}/${o})`),c.gaplimit=Math.ceil(c.gaplimit/2),await e(3e3)};await e(7e3);do{let e;n={};let i=0;for(;i<o;)try{e=await P.post(c);break}catch(e){await l(e,++i)}s=!1,c.gaplimit=Math.min(2*c.gaplimit,a),r(Object.values(e.query.pages));let{gapcontinue:g,rvcontinue:d,clcontinue:p}=e.continue||{};for(;d||p;){let e;for(d&&(c.rvcontinue=d),p&&(c.clcontinue=p),i=0;i<o;)try{e=await P.post(c);break}catch(e){await l(e,++i)}if(s=!1,c.gaplimit=Math.min(2*c.gaplimit,a),r(Object.values(e.query.pages)),e.continue?.gapcontinue){({gapcontinue:g}=e.continue),Reflect.deleteProperty(c,"rvcontinue"),Reflect.deleteProperty(c,"clcontinue");break}let t=!1;if(e.continue?.rvcontinue&&(({rvcontinue:d}=e.continue),t=!0),e.continue?.clcontinue&&(({clcontinue:p}=e.continue),t=!0),!t)break}c.gapcontinue=g;for(const[e,{text:i,categories:o}]of Object.entries(n))for(const a of t)a(i,o,e)}while(void 0!==c.gapcontinue)},v=async(e=0)=>{let t="",o=0;do{if(o>=10)throw new Error("获取疑似繁体页面名尝试次数过多。");try{const o=await P.post({action:"query",format:"json",prop:"info",generator:"allpages",inprop:"varianttitles",gapfilterredir:"nonredirects",gaplimit:"max",gapnamespace:e,gapcontinue:t});t=o.continue?.gapcontinue;for(const{title:e,varianttitles:{"zh-cn":t}}of Object.values(o.query.pages))/[ぁ-んァ-ヶ]/.test(e)||e.replace(/^(?:Category|Template):/,"")===t.replace(/^(?:分类|模板):/,"")||i.addPageToList("疑似繁体页面名",[`:${e}`,`→${t}`])}catch(e){o++}}while(t)};(async()=>{a=(await t("Category:页顶提示模板")).map(e=>e.replace("Template:","")).filter(e=>!["架空历史"].includes(e)),await L([s,r,c,u,m,p,g,d,f,l,y,b,T,x],0,20),await L([w,h,k,y,$,x],10,10),await v(0),await v(10),await v(14),await(async(t=5)=>{const o="User:BearBin/杂物";let a=0;for(;a<t;)try{return void await P.postWithToken("csrf",{action:"edit",title:o,summary:"自动更新列表",text:i.wikitext,bot:!0,tags:"Bot"})}catch(i){console.error(`保存出错：${i}，即将重试(${++a}/${t})`),await e(3e3)}throw new Error(`保存到[4m${o}[0m失败。`)})()})()})())})();