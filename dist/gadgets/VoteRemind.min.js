$((()=>(async()=>{if(!document.getElementsByClassName("votebox")[0]||!mw.config.get("wgTitle").startsWith("提案/讨论中提案/")&&"讨论版/权限变更"!==mw.config.get("wgTitle"))return;await mw.loader.using(["mediawiki.api","mediawiki.util","mediawiki.notification","oojs-ui","ext.gadget.site-lib"]);const e=new mw.Api,t=$(document.body),i=mw.config.get("wgPageName"),s=mw.config.get("wgTitle").startsWith("提案/讨论中提案/"),o=mw.config.get("wgUserGroups").includes("flood"),n=wgULS("一键发送投票提醒","一鍵發送投票提醒");class a extends OO.ui.ProcessDialog{failList=[];static static={...super.static,tagName:"div",name:"lr-reminder",title:n,actions:[{action:"cancel",label:"取消",flags:["safe","close","destructive"]},{action:"submit",label:wgULS("发送","發送"),flags:["primary","progressive"]}]};constructor(e){super(e)}initialize(){super.initialize(),this.panelLayout=new OO.ui.PanelLayout({scrollable:!1,expanded:!1,padded:!0}),this.proposalTitleBox=new OO.ui.TextInputWidget({value:i.substring(i.lastIndexOf("/")+1,i.length),validate:"non-empty"});const e=new OO.ui.FieldLayout(this.proposalTitleBox,{label:wgULS("提案标题","提案標題"),align:"top"});this.headlines=[];for(const e of $(".votebox").parent(".discussionContainer").children("h2").children(".mw-headline"))this.headlines.push(e.id);this.sectionTitleDropdown=new OO.ui.DropdownInputWidget({options:[...this.headlines.map((e=>({data:e,label:e.replaceAll("_"," ")})))]});const t=new OO.ui.FieldLayout(this.sectionTitleDropdown,{label:wgULS("人事案标题","人事案標題"),align:top});this.Papp=new OO.ui.RadioOptionWidget({data:"p",label:"管理员、巡查姬",selected:!0}),this.Sapp=new OO.ui.RadioOptionWidget({data:"s",label:"管理员"}),this.groupsRadioSelect=new OO.ui.RadioSelectWidget({items:[this.Papp,this.Sapp]});const o=new OO.ui.FieldLayout(this.groupsRadioSelect,{label:wgULS("要提醒的用户组","要提醒的用戶組"),align:top});s?this.panelLayout.$element.append(e.$element):this.panelLayout.$element.append(t.$element,o.$element),this.$body.append(this.panelLayout.$element)}get proposalTitle(){return this.proposalTitleBox.getValue()}get sectionTitle(){return this.sectionTitleDropdown.getValue()}get groupSelected(){var e,t;return null===(e=this.groupsRadioSelect.findSelectedItem())||void 0===e||null===(t=e.getData)||void 0===t?void 0:t.call(e)}async getUserGroup(){const t=await e.post({action:"query",titles:"Module:UserGroup/data",prop:"revisions",rvprop:"content",rvlimit:1}),i=JSON.parse(Object.values(t.query.pages)[0].revisions[0]["*"]);let o;if(s)o=[...i.sysop,...i.patroller];else switch(this.groupSelected){case"p":o=[...i.sysop,...i.patroller];break;case"s":o=i.sysop}return o}get userVoted(){const e=[],t=[];s?$(".votebox ~ ol a[href^='/User'], .votebox ~ ol a[href^='/index.php?title=User']").each((function(){t.push(this.href)})):$(`#${this.sectionTitle.replaceAll(":","\\:")}`).parents(".discussionContainer").find(".votebox ~ ol a[href^='/User'], .votebox ~ ol a[href^='/index.php?title=User']").each((function(){t.push(this.href)}));for(const i of t)e.push(decodeURI(i.replace(/.*User(_talk)?:([^&]*).*/g,"$2")));return e}async getUserToRemind(){let t;await this.getUserGroup().then((e=>{t=e}));const i=await e.post({action:"query",titles:"User:BearBin/js/voteRemind.js/Noremind",prop:"revisions",rvprop:"content",rvlimit:1}),o=Object.values(i.query.pages)[0].revisions[0]["*"].split(/\n\* */);let n;s||(n=this.sectionTitle.replace(/.*User:(.*)/g,"$1").replaceAll("_"," "));const a=new Set([...this.userVoted,...o,n]);return t.filter((e=>!a.has(e)))}get link(){return s?`[[萌娘百科_talk:提案/讨论中提案/${this.proposalTitle}|${this.proposalTitle.replaceAll("_"," ")}]]`:`[[萌娘百科_talk:讨论版/权限变更#${this.sectionTitle}|${this.sectionTitle.replaceAll("_"," ")}]]`}async remind(t){const i=await e.postWithToken("csrf",{format:"json",action:"edit",section:"new",watchlist:"nochange",tags:"Automation tool",bot:o,title:`User_talk:${t}`,sectiontitle:"投票提醒",text:`<i style="font-size:small">本通知使用一键提醒小工具发出，如出现错误，请联系[[User_talk:BearBin|BearBin]]。若不希望接到此提醒，请在[[User:BearBin/js/voteRemind.js/Noremind|这个页面]]记录您的用户名。</i><br/>您好，${s?"提案":"人事案"}【${this.link}】已经开始投票。您尚未投票，请及时参与喵～——~~~~`}).done((()=>{mw.notify(wgULS(`向${t}发送投票提醒成功。`,`向${t}發送投票提醒成功。`))}));i.error&&(this.failList.push(t),mw.notify(wgULS(`向${t}发送投票提醒失败：${i.error.code}。`,`向${t}發送投票提醒失敗：${i.error.code}。`),{type:"error"}))}getActionProcess(e){return"cancel"===e?new OO.ui.Process((()=>{this.close({action:e})}),this):"submit"===e?new OO.ui.Process($.when((async()=>{this.failList=[],await this.getUserToRemind().then((async e=>{for(const t of e)await this.remind(t)})),this.failList.length>0&&oouiDialog.alert(this.failList.join("、"),{title:wgULS("向以下用户发送提醒失败","向以下使用者發送提醒失敗"),size:"small"}),this.close({action:e})})()).promise(),this):super.getActionProcess(e)}}const l=new OO.ui.WindowManager;t.append(l.$element);const r=new a({size:"medium",id:"bearbin-vote-remind"});l.addWindows([r]),$(mw.util.addPortletLink("p-cactions","javascript:void(0)","投票提醒","ca-vote-remind",n,"r")).on("click",(e=>{e.preventDefault(),l.openWindow(r),t.css("overflow","auto")}))})()));