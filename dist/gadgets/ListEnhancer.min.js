(()=>{"use strict";const e=async e=>{const t=new mw.Api;let a=1;const n=[];for(;a;){const i=await t.get({action:"query",prop:"transcludedin",titles:e,tilimit:"max",ticontinue:a});if(Object.values(i.query.pages)[0].transcludedin)for(const{title:e}of Object.values(i.query.pages)[0].transcludedin)n.push(e);a=!!i.continue&&i.continue.ticontinue}return n},t=async e=>{const t=new mw.Api;let a=1;const n=[];for(;a;){var i;const s=await t.get({action:"query",prop:"linkshere",titles:e,lhlimit:"max",lhcontinue:a});if(Object.values(s.query.pages)[0].linkshere)for(const{title:e}of Object.values(s.query.pages)[0].linkshere)n.push(e);a=null===(i=s.continue)||void 0===i?void 0:i.lhcontinue}return n},a=async e=>{const t=new mw.Api;let a="";const n=[];for(;a;){var i;const s=await t.get({action:"query",prop:"redirects",titles:e,tilimit:"max",rdcontinue:a});if(Object.values(s.query.pages)[0].transcludedin)for(const{title:e}of Object.values(s.query.pages)[0].redirects)n.push(e);a=null===(i=s.continue)||void 0===i?void 0:i.rdcontinue}return n},n=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["page","subcat","file"];const a=new mw.Api,n=[];if(mw.config.get("wgUserGroups").some((e=>["bot","flood","patroller","sysop"].includes(e)))){let s="";for(;void 0!==s;){var i;const c=await a.get({action:"query",list:"categorymembers",cmlimit:"max",cmtitle:e,cmtype:t.join("|"),cmcontinue:s});if(c.query.categorymembers[0])for(const e of c.query.categorymembers)n.push(e.title);s=null===(i=c.continue)||void 0===i?void 0:i.cmcontinue}}else{const a=async e=>{const i=await $.ajax(e),s=t.map((e=>{switch(e){case"page":return"#mw-pages li a";case"subcat":return"#mw-subcategories li a";case"file":return"#mw-category-media li a.galleryfilename"}})).join(","),c=$(i).find(s).map(((e,t)=>t.classList.contains("CategoryTreeLabel")?`Category:${$(t).text()}`:t.classList.contains("galleryfilename")?`File:${$(t).text()}`:$(t).text())).get();if(n.push(...c),t.includes("page")){const e=$(i).find('a[href*="&pagefrom="]');e.length>0&&await a(e.eq(0).attr("href"))}if(t.includes("subcat")){const e=$(i).find('a[href*="&subcatfrom="]');e.length>0&&await a(e.eq(0).attr("href"))}if(t.includes("file")){const e=$(i).find('a[href*="&filefrom="]');e.length>0&&await a(e.eq(0).attr("href"))}};await a(`/${e}?action=render`)}return n};mw.loader.using(["mediawiki.notification","mediawiki.api"]).done((()=>{const i=function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"复制成功",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"复制失败";const i=t.text();(async function(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if("function"==typeof(null===(e=navigator.clipboard)||void 0===e?void 0:e.writeText))await navigator.clipboard.writeText(t);else{const e=document.createElement("input");e.style.position="fixed",e.style.top="-10000px",e.style.zIndex="-999",e.style.opacity=0,document.body.appendChild(e),e.value=t,e.focus(),e.select(),document.execCommand("copy"),document.body.removeChild(e)}})(e).then((()=>{t.text(a),setTimeout((()=>t.text(i)),3e3)}),(e=>{t.text(n),mw.notify($(`<span>复制失败: ${e}${e.includes("NotAllowedError")?"<br/>您可能正在使用firefox，或请求响应时间过久，请重新尝试复制。":""}</span>`),{type:"error",autoHideSeconds:"long"}),setTimeout((()=>t.text(i)),3e3)}))};if(-1===mw.config.get("wgNamespaceNumber")){const n=()=>{$("#mw-whatlinkshere-list").before($('<span class="listenhancer-linkshere"></span>').append("（",$("<a>复制本页</a>").on("click",(e=>{let{target:t}=e;const a=$("#mw-whatlinkshere-list>li>a").map(((e,t)=>$(t).text())).get();i(a.join("\n"),$(t))})),$('#mw-content-text a[href*="&from="]').length>0?" | ":null,$('#mw-content-text a[href*="&from="]').length>0?$("<a>复制全部</a>").on("click",(n=>{let{target:s}=n;try{const n=new URLSearchParams(location.search),c=[n.get("hidetrans")?Promise.resolve([]):e(mw.config.get("wgRelevantPageName")),n.get("hidelinks")?Promise.resolve([]):t(mw.config.get("wgRelevantPageName")),n.get("hideredirs")?Promise.resolve([]):a(mw.config.get("wgRelevantPageName"))];Promise.all(c).then((e=>{const t=[].concat(...e);i(t.join("\n"),$(s))}))}catch(e){mw.notify($(`复制失败: ${e}`),{type:"error",autoHideSeconds:"long"})}})):null,"）"))},s=()=>{mw.loader.addStyleTag(".search-types{display:flex;float:none;align-items:center;}#bearbintools-listenhancer-search{padding:.5em;user-select:none;}#bearbintools-listenhancer-search a{display:inline;padding:0;}.listenhancer-search-edit{margin-left:.5em;float:right;}");let e=!0;const t=[],a=$(".search-types li").eq(1),n=a.clone(!1);n.children("a").text("替换空间").attr("title","主、模板等替换常用名字空间").attr("href",((e,t)=>t.replace("profile=images","profile=advanced&limit=500&ns0=1&ns2=1&ns6=1&ns10=1&ns12=1&ns14=1&ns828=1"))),n.insertAfter(a),$("a[data-serp-pos]").each(((e,a)=>{t.push(decodeURIComponent($(a).attr("href")).replace("/","").replaceAll("_"," ")),$(a).before(`<a class="listenhancer-search-edit" href="${a.href}?action=edit">[编辑]</a>`)}));const s=$("<a>隐藏详情</a>").on("click",(t=>{e?($(".searchresult, .mw-search-result-data").hide(),$(".mw-search-results li").css("padding-bottom","0.1em"),$(t.target).text("显示详情"),e=!1):($(".searchresult, .mw-search-result-data").show(),$(".mw-search-results li").css("padding-bottom",""),$(t.target).text("隐藏详情"),e=!0)})),c=$("<a>复制列表</a>").on("click",(e=>{i(t.join("\n"),$(e.target))}));$("#search .search-types, #powersearch .search-types").append($('<div id="bearbintools-listenhancer-search"></div>').append('<span class="mw-editsection-bracket">[</span>',s,'<span class="mw-editsection-divider"> | </span>',c,'<span class="mw-editsection-bracket">]</span>')),$(".mw-search-pager-bottom").clone().prependTo($(".searchresults"))};switch(mw.config.get("wgCanonicalSpecialPageName")){case"Whatlinkshere":n();break;case"Search":s()}}else if(14===mw.config.get("wgNamespaceNumber")){const e=$("#mw-subcategories"),t=$("#mw-pages"),a=$("#mw-category-media"),s=e=>$("<a>复制全部</a>").on("click",(async t=>{let{target:a}=t;if(!window.listEnhancerCopyText){const t=await n(mw.config.get("wgPageName"),e);Object.defineProperty(window,"listEnhancerCopyText",{value:t.join("\n"),writable:!0,configurable:!0})}i(window.listEnhancerCopyText,$(a))}));e.find("h2").append($('<span class="mw-editsection"></span>').append('<span class="mw-editsection-bracket">[</span>',$("<a>复制本页</a>").on("click",(t=>{let{target:a}=t;i(e.find("li a").map(((e,t)=>`Category:${$(t).text()}`)).get().join("\n"),$(a))})),e.children("a").length?'<span class="mw-editsection-divider"> | </span>':null,e.children("a").length?s(["subcat"]):null,'<span class="mw-editsection-bracket">]</span>')),t.find("h2").append($('<span class="mw-editsection"></span>').append('<span class="mw-editsection-bracket">[</span>',$("<a>复制本页</a>").on("click",(e=>{let{target:a}=e;i(t.find("li a").map(((e,t)=>$(t).text())).get().join("\n"),$(a))})),t.children("a").length?'<span class="mw-editsection-divider"> | </span>':null,t.children("a").length?s(["page"]):null,'<span class="mw-editsection-bracket">]</span>')),a.find("h2").append($('<span class="mw-editsection"></span>').append('<span class="mw-editsection-bracket">[</span>',$("<a>复制本页</a>").on("click",(e=>{let{target:t}=e;i(a.find("li a.galleryfilename").map(((e,t)=>`File:${$(t).text()}`)).get().join("\n"),$(t))})),a.children("a").length?'<span class="mw-editsection-divider"> | </span>':null,a.children("a").length?s(["file"]):null,'<span class="mw-editsection-bracket">]</span>'))}}))})();