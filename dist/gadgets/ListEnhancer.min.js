(()=>{"use strict";const e=async e=>{const t=new mw.Api;let n=1;const a=[];for(;n;){const i=await t.get({action:"query",prop:"transcludedin",titles:e,tilimit:"max",ticontinue:n});if(Object.values(i.query.pages)[0].transcludedin)for(const{title:e}of Object.values(i.query.pages)[0].transcludedin)a.push(e);n=i.continue?.ticontinue}return a},t=async e=>{const t=new mw.Api;let n=1;const a=[];for(;n;){const i=await t.get({action:"query",prop:"linkshere",titles:e,lhlimit:"max",lhcontinue:n});if(Object.values(i.query.pages)[0].linkshere)for(const{title:e}of Object.values(i.query.pages)[0].linkshere)a.push(e);n=i.continue?.lhcontinue}return a},n=async e=>{const t=new mw.Api;let n="";const a=[];for(;void 0!==n;){const i=await t.get({action:"query",prop:"redirects",titles:e,rdlimit:"max",rdcontinue:n});if(Object.values(i.query.pages)[0].transcludedin)for(const{title:e}of Object.values(i.query.pages)[0].redirects)a.push(e);n=i.continue?.rdcontinue}return a},a=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["page","subcat","file"];const n=new mw.Api,a=[];if(mw.config.get("wgUserGroups").some((e=>["bot","flood","patroller","sysop"].includes(e)))){let i="";for(;void 0!==i;){const s=await n.get({action:"query",list:"categorymembers",cmlimit:"max",cmtitle:e,cmtype:t.join("|"),cmcontinue:i});if(s.query.categorymembers[0])for(const e of s.query.categorymembers)a.push(e.title);i=s.continue?.cmcontinue}}else{const n=async e=>{const i=await $.ajax(e),s=t.map((e=>{switch(e){case"page":return"#mw-pages li a";case"subcat":return"#mw-subcategories li a";case"file":return"#mw-category-media li a.galleryfilename"}})).join(","),c=$(i).find(s).map(((e,t)=>t.classList.contains("CategoryTreeLabel")?`Category:${$(t).text()}`:t.classList.contains("galleryfilename")?`File:${$(t).text()}`:$(t).text())).get();if(a.push(...c),t.includes("page")){const e=$(i).find('a[href*="&pagefrom="]');e.length>0&&await n(e.eq(0).attr("href"))}if(t.includes("subcat")){const e=$(i).find('a[href*="&subcatfrom="]');e.length>0&&await n(e.eq(0).attr("href"))}if(t.includes("file")){const e=$(i).find('a[href*="&filefrom="]');e.length>0&&await n(e.eq(0).attr("href"))}};await n(`/${e}?action=render`)}return a};mw.loader.using(["mediawiki.notification","mediawiki.api"]).done((()=>{const i=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"复制成功",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"复制失败";const i=t.text();(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if("function"==typeof navigator.clipboard?.writeText)await navigator.clipboard.writeText(e);else{const t=document.createElement("input");t.style.position="fixed",t.style.top="-10000px",t.style.zIndex="-999",t.style.opacity=0,document.body.appendChild(t),t.value=e,t.focus(),t.select(),document.execCommand("copy"),document.body.removeChild(t)}})(e).then((()=>{t.text(n),setTimeout((()=>t.text(i)),3e3)}),(e=>{t.text(a),mw.notify($(`<span>复制失败: ${e}${e.includes("NotAllowedError")?"<br/>您可能正在使用firefox，或请求响应时间过久，请重新尝试复制。":""}</span>`),{type:"error",autoHideSeconds:"long"}),setTimeout((()=>t.text(i)),3e3)}))},s=e=>{Object.defineProperty(window,"listEnhancerCopyText",{value:e,writable:!0,configurable:!0})},c='<span class="mw-editsection"></span>',o='<span class="mw-editsection-bracket">[</span>',r='<span class="mw-editsection-bracket">]</span>',l='<span class="mw-editsection-divider"> | </span>',d=mw.config.get("wgNamespaceNumber");if(-1===d){const a=()=>$("#mw-whatlinkshere-list").before($('<span class="listenhancer-linkshere"></span>').append("（",$("<a>复制本页</a>").on("click",(e=>{let{target:t}=e;const n=$("#mw-whatlinkshere-list>li>a").map(((e,t)=>$(t).text())).get();i(n.join("\n"),$(t))})),$('#mw-content-text a[href*="&from="]').length?" | ":null,$('#mw-content-text a[href*="&from="]').length?$("<a>复制全部</a>").on("click",(async a=>{let{target:c}=a;if(!window.listEnhancerCopyText)try{const a=new URLSearchParams(location.search),i=mw.config.get("wgRelevantPageName"),c=[a.get("hidetrans")?Promise.resolve([]):e(i),a.get("hidelinks")?Promise.resolve([]):t(i),a.get("hideredirs")?Promise.resolve([]):n(i)];await Promise.all(c).then((e=>{const t=[].concat(...e);s(t.join("\n"))}))}catch(e){mw.notify($(`读取列表失败: ${e}`),{type:"error",autoHideSeconds:"long"})}i(window.listEnhancerCopyText,$(c))})):null,"）")),c=()=>{mw.loader.addStyleTag(".search-types{display:flex;float:none;align-items:center;}#bearbintools-listenhancer-search{padding:.5em;user-select:none;}#bearbintools-listenhancer-search a{display:inline;padding:0;}.listenhancer-search-edit{margin-left:.5em;float:right;}");let e=!0;const t=[],n=$(".search-types li").eq(1),a=n.clone(!1);a.children("a").text("替换空间").attr("title","主、模板等替换常用名字空间").attr("href",((e,t)=>t.replace("profile=images","profile=advanced&limit=500&ns0=1&ns2=1&ns6=1&ns10=1&ns12=1&ns14=1&ns828=1"))),a.insertAfter(n),$("a[data-serp-pos]").each(((e,n)=>{t.push(decodeURIComponent($(n).attr("href")).replace("/","").replaceAll("_"," ")),$(n).before(`<a class="listenhancer-search-edit" href="${n.href}?action=edit">[编辑]</a>`)}));const s=$("<a>隐藏详情</a>").on("click",(t=>{let{target:n}=t;e?($(".searchresult, .mw-search-result-data").hide(),$(".mw-search-results li").css("padding-bottom","0.1em"),$(n).text("显示详情"),e=!1):($(".searchresult, .mw-search-result-data").show(),$(".mw-search-results li").css("padding-bottom",""),$(n).text("隐藏详情"),e=!0)})),c=$("<a>复制列表</a>").on("click",(e=>{let{target:n}=e;i(t.join("\n"),$(n))}));$("#search .search-types, #powersearch .search-types").append($('<div id="bearbintools-listenhancer-search"></div>').append(o,s,l,c,r)),$(".mw-search-pager-bottom").clone().prependTo($(".searchresults"))};switch(mw.config.get("wgCanonicalSpecialPageName")){case"Whatlinkshere":a();break;case"Search":c()}}else if(14===d){const e=$("#mw-subcategories"),t=$("#mw-pages"),n=$("#mw-category-media"),d=e=>$("<a>复制全部</a>").on("click",(async t=>{let{target:n}=t;if(!window.listEnhancerCopyText){const t=await a(mw.config.get("wgPageName"),e);s(t.join("\n"))}i(window.listEnhancerCopyText,$(n))}));e.find("h2").append($(c).append(o,$("<a>复制本页</a>").on("click",(t=>{let{target:n}=t;i(e.find("li a").map(((e,t)=>`Category:${$(t).text()}`)).get().join("\n"),$(n))})),e.children("a").length?l:null,e.children("a").length?d(["subcat"]):null,r)),t.find("h2").append($(c).append(o,$("<a>复制本页</a>").on("click",(e=>{let{target:n}=e;i(t.find("li a").map(((e,t)=>$(t).text())).get().join("\n"),$(n))})),t.children("a").length?l:null,t.children("a").length?d(["page"]):null,r)),n.find("h2").append($(c).append(o,$("<a>复制本页</a>").on("click",(e=>{let{target:t}=e;i(n.find("li a.galleryfilename").map(((e,t)=>`File:${$(t).text()}`)).get().join("\n"),$(t))})),n.children("a").length?l:null,n.children("a").length?d(["file"]):null,r))}}))})();