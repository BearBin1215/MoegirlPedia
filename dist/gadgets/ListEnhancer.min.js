(()=>{"use strict";const e=async e=>{const t=new mw.Api;let a=1;const n=[];for(;a;){var i;const s=await t.get({action:"query",prop:"transcludedin",titles:e,tilimit:"max",ticontinue:a});if(Object.values(s.query.pages)[0].transcludedin)for(const{title:e}of Object.values(s.query.pages)[0].transcludedin)n.push(e);a=null===(i=s.continue)||void 0===i?void 0:i.ticontinue}return n},t=async e=>{const t=new mw.Api;let a=1;const n=[];for(;a;){var i;const s=await t.get({action:"query",prop:"linkshere",titles:e,lhlimit:"max",lhcontinue:a});if(Object.values(s.query.pages)[0].linkshere)for(const{title:e}of Object.values(s.query.pages)[0].linkshere)n.push(e);a=null===(i=s.continue)||void 0===i?void 0:i.lhcontinue}return n},a=async e=>{const t=new mw.Api;let a="";const n=[];for(;void 0!==a;){var i;const s=await t.get({action:"query",prop:"redirects",titles:e,rdlimit:"max",rdcontinue:a});if(Object.values(s.query.pages)[0].transcludedin)for(const{title:e}of Object.values(s.query.pages)[0].redirects)n.push(e);a=null===(i=s.continue)||void 0===i?void 0:i.rdcontinue}return n},n=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["page","subcat","file"];const a=new mw.Api,n=[];if(mw.config.get("wgUserGroups").some((e=>["bot","flood","patroller","sysop"].includes(e)))){let s="";for(;void 0!==s;){var i;const o=await a.get({action:"query",list:"categorymembers",cmlimit:"max",cmtitle:e,cmtype:t.join("|"),cmcontinue:s});if(o.query.categorymembers[0])for(const e of o.query.categorymembers)n.push(e.title);s=null===(i=o.continue)||void 0===i?void 0:i.cmcontinue}}else{const a=async e=>{const i=$(await $.ajax(e)),s=t.map((e=>{switch(e){case"page":return"#mw-pages li a";case"subcat":return"#mw-subcategories li a";case"file":return"#mw-category-media li a.galleryfilename"}})).join(","),o=i.find(s).map(((e,t)=>t.classList.contains("CategoryTreeLabel")?`Category:${$(t).text()}`:t.classList.contains("galleryfilename")?`File:${$(t).text()}`:$(t).text())).get();if(n.push(...o),t.includes("page")){const e=i.find('a[href*="&pagefrom="]');e.length&&await a(e.eq(0).attr("href"))}if(t.includes("subcat")){const e=i.find('a[href*="&subcatfrom="]');e.length&&await a(e.eq(0).attr("href"))}if(t.includes("file")){const e=i.find('a[href*="&filefrom="]');e.length&&await a(e.eq(0).attr("href"))}};await a(`/${e}?action=render`)}return n};mw.loader.using(["mediawiki.notification","mediawiki.api"]).done((()=>{let i;const s=function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"复制成功",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"复制失败";const i=t.text();(async function(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if("function"==typeof(null===(e=navigator.clipboard)||void 0===e?void 0:e.writeText))await navigator.clipboard.writeText(t);else{const e=document.createElement("input");e.style.position="fixed",e.style.top="-10000px",e.style.zIndex="-999",e.style.opacity=0,document.body.appendChild(e),e.value=t,e.focus(),e.select(),document.execCommand("copy"),document.body.removeChild(e)}})(e).then((()=>{t.text(a),setTimeout((()=>t.text(i)),3e3)}),(e=>{t.text(n),mw.notify($(`<span>复制失败: ${e}${e.includes("NotAllowedError")?"<br/>您可能正在使用firefox，或请求响应时间过久，请重新尝试复制。":""}</span>`),{type:"error",autoHideSeconds:"long"}),setTimeout((()=>t.text(i)),3e3)}))},o=e=>{i=e},r='<span class="mw-editsection-bracket">[</span>',c='<span class="mw-editsection-bracket">]</span>',l='<span class="mw-editsection-divider"> | </span>',d=mw.config.get("wgNamespaceNumber");if(-1===d){const n=()=>$("#mw-whatlinkshere-list").before($('<span class="listenhancer-linkshere"></span>').append("（",$("<a>复制本页</a>").on("click",(e=>{let{target:t}=e;const a=$("#mw-whatlinkshere-list>li>a").map(((e,t)=>$(t).text())).get();s(a.join("\n"),$(t))})),$('#mw-content-text a[href*="&from="]').length?" | ":null,$('#mw-content-text a[href*="&from="]').length?$("<a>复制全部</a>").on("click",(async n=>{let{target:r}=n;if(!i)try{const n=new URLSearchParams(location.search),i=mw.config.get("wgRelevantPageName"),s=[n.get("hidetrans")?Promise.resolve([]):e(i),n.get("hidelinks")?Promise.resolve([]):t(i),n.get("hideredirs")?Promise.resolve([]):a(i)];await Promise.all(s).then((e=>{const t=[].concat(...e);o(t.join("\n"))}))}catch(e){mw.notify($(`读取列表失败: ${e}`),{type:"error",autoHideSeconds:"long"})}s(i,$(r))})):null,"）")),d=()=>{mw.loader.addStyleTag(".search-types{display:flex;float:none;align-items:center;}#bearbintools-listenhancer-search{padding:.5em;user-select:none;}#bearbintools-listenhancer-search a{display:inline;padding:0;}.listenhancer-search-edit{margin-left:.5em;float:right;}");let e=!0;const t=[],a=$(".search-types li").eq(1),n=a.clone(!1);n.children("a").text("替换空间").attr("title","主、模板等替换常用名字空间").attr("href",((e,t)=>t.replace("profile=images","profile=advanced&limit=500&ns0=1&ns2=1&ns6=1&ns10=1&ns12=1&ns14=1&ns828=1"))),n.insertAfter(a),$("a[data-serp-pos]").each(((e,a)=>{t.push(decodeURIComponent($(a).attr("href")).replace("/","").replace(/_/g," ")),$(a).before(`<a class="listenhancer-search-edit" href="${a.href}?action=edit">[编辑]</a>`)}));const i=$("<a>隐藏详情</a>").on("click",(t=>{let{target:a}=t;e?($(".searchresult, .mw-search-result-data").hide(),$(".mw-search-results li").css("padding-bottom","0.1em"),$(a).text("显示详情"),e=!1):($(".searchresult, .mw-search-result-data").show(),$(".mw-search-results li").css("padding-bottom",""),$(a).text("隐藏详情"),e=!0)})),o=$("<a>复制列表</a>").on("click",(e=>{let{target:a}=e;s(t.join("\n"),$(a))}));$("#search .search-types, #powersearch .search-types").append($('<div id="bearbintools-listenhancer-search"></div>').append(r,i,l,o,c)),$(".mw-search-pager-bottom").clone().prependTo($(".searchresults"))};switch(mw.config.get("wgCanonicalSpecialPageName")){case"Whatlinkshere":n();break;case"Search":d()}}else if(14===d){const e=function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"li a";e.find("h2").append($('<span class="mw-editsection"></span>').append(r,$("<a>复制本页</a>").on("click",(t=>{let{target:n}=t;s(e.find(d).map(((e,t)=>`${a}${$(t).text()}`)).get().join("\n"),$(n))})),e.children("a").length?l:null,e.children("a").length?$("<a>复制全部</a>").on("click",(async e=>{let{target:a}=e;if(!i){const e=await n(mw.config.get("wgPageName"),[t]);o(e.join("\n"))}s(i,$(a))})):null,c))};e($("#mw-subcategories"),"subcat","Category:"),e($("#mw-pages"),"page"),e($("#mw-category-media"),"file","File:","li a.galleryfilename")}}))})();