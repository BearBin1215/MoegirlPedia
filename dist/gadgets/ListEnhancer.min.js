(()=>{"use strict";const e=async(e,t)=>{const a=new mw.Api;let n="1";const i=[];for(;n;){const s={action:"query",prop:"transcludedin",titles:e,tilimit:"max",ticontinue:n};t&&(s.tinamespace=t);const c=await a.post(s);i.push(...(Object.values(c.query.pages)[0].transcludedin||[]).map((({title:e})=>e))),n=c.continue?.ticontinue}return i},t=async(e,t)=>{const a=new mw.Api;let n="1";const i=[];for(;n;){const s={action:"query",prop:"linkshere",titles:e,lhlimit:"max",lhcontinue:n};t&&(s.lhnamespace=t);const c=await a.post(s);i.push(...(Object.values(c.query.pages)[0].linkshere||[]).map((({title:e})=>e))),n=c.continue?.lhcontinue}return i},a=async e=>{const t=new mw.Api;let a="";const n=[];for(;void 0!==a;){const i=await t.post({action:"query",prop:"redirects",titles:e,rdlimit:"max",rdcontinue:a});n.push(...(Object.values(i.query.pages)[0].redirects||[]).map((({title:e})=>e))),a=i.continue?.rdcontinue}return n},n=async(e,t=["page","subcat","file"])=>{const a=new mw.Api,n=[];if(mw.config.get("wgUserGroups").some((e=>["bot","flood","patroller","sysop"].includes(e)))){let i="";for(;void 0!==i;){const s=await a.post({action:"query",list:"categorymembers",cmlimit:"max",cmtitle:e,cmtype:t,cmcontinue:i});if(s.query.categorymembers[0])for(const e of s.query.categorymembers)n.push(e.title);i=s.continue?.cmcontinue}}else{const a=async e=>{const i=$(await $.ajax(e)),s=t.map((e=>{switch(e){case"page":return"#mw-pages li a";case"subcat":return"#mw-subcategories li a";case"file":return"#mw-category-media li a.galleryfilename"}})).join(","),c=i.find(s).map(((e,t)=>t.classList.contains("CategoryTreeLabel")?`Category:${$(t).text()}`:t.classList.contains("galleryfilename")?`File:${$(t).text()}`:$(t).text())).get();if(n.push(...c),t.includes("page")){const e=i.find('a[href*="&pagefrom="]');e.length&&await a(e.eq(0).attr("href"))}if(t.includes("subcat")){const e=i.find('a[href*="&subcatfrom="]');e.length&&await a(e.eq(0).attr("href"))}if(t.includes("file")){const e=i.find('a[href*="&filefrom="]');e.length&&await a(e.eq(0).attr("href"))}};await a(`/${e}?action=render`)}return n};mw.loader.using(["mediawiki.notification","mediawiki.api"]).done((()=>{let i;const s=(e,t,a="复制成功",n="复制失败")=>{const i=t.text();(async(e="")=>{if("function"==typeof navigator.clipboard?.writeText)await navigator.clipboard.writeText(e);else{const t=document.createElement("input");t.style.position="fixed",t.style.top="-10000px",t.style.zIndex="-999",t.style.opacity="0",document.body.appendChild(t),t.value=e,t.focus(),t.select(),document.execCommand("copy"),document.body.removeChild(t)}})(e).then((()=>{t.text(a),setTimeout((()=>t.text(i)),3e3)}),(e=>{t.text(n),mw.notify($(`<span>复制失败: ${e}${e.includes("NotAllowedError")?"<br/>您可能正在使用firefox，或请求响应时间过久，请重新尝试复制。":""}</span>`),{type:"error",autoHideSeconds:"long"}),setTimeout((()=>t.text(i)),3e3)}))},c='<span class="mw-editsection-bracket">[</span>',r='<span class="mw-editsection-bracket">]</span>',o='<span class="mw-editsection-divider"> | </span>',l=mw.config.get("wgNamespaceNumber");if(-1===l){const n=()=>$("#mw-whatlinkshere-list").before($('<span class="listenhancer-linkshere"></span>').append("（",$("<a>复制本页</a>").on("click",(({target:e})=>{const t=$("#mw-whatlinkshere-list>li>a").map(((e,t)=>$(t).text())).get();s(t.join("\n"),$(e))})),$('#mw-content-text a[href*="&from="]').length?" | ":"",$('#mw-content-text a[href*="&from="]').length?$("<a>复制全部</a>").on("click",(async({target:n})=>{if(!i){const n=new URLSearchParams(location.search),s=mw.config.get("wgRelevantPageName"),c=[n.get("hidetrans")?Promise.resolve([]):e(s),n.get("hidelinks")?Promise.resolve([]):t(s),n.get("hideredirs")?Promise.resolve([]):a(s)];await Promise.all(c).then((e=>{const t=[].concat(...e);i=t.join("\n")}))}s(i,$(n))})):"","）")),l=()=>{mw.loader.addStyleTag(".search-types{display:flex;float:none;align-items:center;}#bearbintools-listenhancer-search{padding:.5em;user-select:none;}#bearbintools-listenhancer-search a{display:inline;padding:0;}.listenhancer-search-edit{margin-left:.5em;float:right;}");let e=!0;const t=[],a=$(".search-types li").eq(1),n=a.clone(!1);n.children("a").text("替换空间").attr("title","主、模板等替换常用名字空间").attr("href",((e,t)=>t.replace("profile=images","profile=advanced&limit=500&ns0=1&ns2=1&ns6=1&ns10=1&ns12=1&ns14=1&ns828=1"))),n.insertAfter(a),$("a[data-serp-pos]").each(((e,a)=>{t.push(decodeURIComponent(a.href).replace("/","").replace(/_/g," ")),$(a).before(`<a class="listenhancer-search-edit" href="${a.href}?action=edit">[编辑]</a>`)}));const i=$("<a>隐藏详情</a>").on("click",(({target:t})=>{e?($(".searchresult, .mw-search-result-data").hide(),$(".mw-search-results li").css("padding-bottom","0.1em"),$(t).text("显示详情"),e=!1):($(".searchresult, .mw-search-result-data").show(),$(".mw-search-results li").css("padding-bottom",""),$(t).text("隐藏详情"),e=!0)})),l=$("<a>复制列表</a>").on("click",(({target:e})=>{s(t.join("\n"),$(e))}));$("#search .search-types, #powersearch .search-types").append($('<div id="bearbintools-listenhancer-search"></div>').append(c,i,o,l,r)),$(".mw-search-pager-bottom").clone().prependTo($(".searchresults"))};switch(mw.config.get("wgCanonicalSpecialPageName")){case"Whatlinkshere":n();break;case"Search":l()}}else if(14===l){const e=(e,t,a="",l="li a")=>{e.find("h2").append($('<span class="mw-editsection"></span>').append(c,$("<a>复制本页</a>").on("click",(({target:t})=>{s(e.find(l).map(((e,t)=>`${a}${$(t).text()}`)).get().join("\n"),$(t))})),e.children("a").length?o:"",e.children("a").length?$("<a>复制全部</a>").on("click",(async({target:e})=>{if(!i){const e=await n(mw.config.get("wgPageName"),[t]);i=e.join("\n")}s(i,$(e))})):"",r))};e($("#mw-subcategories"),"subcat","Category:"),e($("#mw-pages"),"page"),e($("#mw-category-media"),"file","File:","li a.galleryfilename")}"history"===mw.config.get("wgAction")&&document.getElementById("ca-edit")&&$("#pagehistory>li:not(:first-child)").each(((e,t)=>{const a=$(t).attr("data-mw-revid"),n=mw.config.get("wgScript");$(t).children(".mw-history-undo").children("a:first-child").after(` | <a title="编辑自此版本" href="${n}?action=edit&oldid=${a}&summary=编辑自[[Special:Permanentlink/${a}|版本${a}]]">编辑</a>`),e===$("#pagehistory>li:not(:first-child)").length-1&&$(t).append(`（<span class="mw-history-undo"><a title="编辑自此版本" href="${n}?action=edit&oldid=${a}&summary=编辑自[[Special:Permanentlink/${a}|版本${a}]]">编辑</a></span>）`)}))}))})();