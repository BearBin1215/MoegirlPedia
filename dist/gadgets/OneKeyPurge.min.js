(()=>{"use strict";var e={922:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",i=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),i&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),i&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,i,o,a){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(i)for(var r=0;r<this.length;r++){var l=this[r][0];null!=l&&(s[l]=!0)}for(var c=0;c<e.length;c++){var u=[].concat(e[c]);i&&s[u[0]]||(void 0!==a&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=a),n&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=n):u[2]=n),o&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=o):u[4]="".concat(o)),t.push(u))}},t}},499:e=>{e.exports=function(e){return e[1]}},768:(e,t,n)=>{n.d(t,{Z:()=>r});var i=n(499),o=n.n(i),a=n(922),s=n.n(a)()(o());s.push([e.id,".snake .snake-head{font-size:1.3em;margin:.8em 0 .5em;text-align:center;text-decoration:underline}.snake .snake-body{display:flex;flex-wrap:wrap;gap:.2em;justify-content:center;max-height:10.5em;overflow-y:auto}.snake .snake-scale{border:1px solid;height:1em;width:1em}.snake .snake-scale[data-scale-state=ongoing],.snake .snake-scale[data-scale-state=ready]{background-color:#eaecf0;border-color:#a2a9b1}.snake .snake-scale[data-scale-state=success]{background-color:#d5fdf4;border-color:#16876e}.snake .snake-scale[data-scale-state=warn]{background-color:#fee7e6;border-color:#d33}.snake .snake-scale[data-scale-state=fail]{background-color:#fef6e7;border-color:#edab00}",""]);const r=s},980:(e,t,n)=>{n.d(t,{Z:()=>r});var i=n(499),o=n.n(i),a=n(922),s=n.n(a)()(o());s.push([e.id,"#one-key-purge .okp-button{flex:0 1;padding:6px}#one-key-purge .okp-header{border-bottom:1px solid #bbb;display:flex}#one-key-purge .okp-header .okp-header-text{align-items:center;display:flex;flex:1 0;font-weight:700;justify-content:center}#one-key-purge .okp-footer{border-top:1px solid #bbb}#one-key-purge .okp-note{font-size:1.143em;line-height:1.3;margin-bottom:.8em}#one-key-purge .oo-ui-fieldLayout-header{font-weight:700;min-width:6em;width:20%}#one-key-purge .oo-ui-multiselectWidget-group,#one-key-purge .oo-ui-radioSelectWidget{display:flex;flex-wrap:wrap}#one-key-purge .oo-ui-multiselectWidget-group>label,#one-key-purge .oo-ui-radioSelectWidget>label{flex:1 0 11em;padding:4px 0}#one-key-purge-help{list-style:circle;padding-left:1.2em}",""]);const r=s},379:e=>{var t=[];function n(e){for(var n=-1,i=0;i<t.length;i++)if(t[i].identifier===e){n=i;break}return n}function i(e,i){for(var a={},s=[],r=0;r<e.length;r++){var l=e[r],c=i.base?l[0]+i.base:l[0],u=a[c]||0,d="".concat(c," ").concat(u);a[c]=u+1;var p=n(d),h={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==p)t[p].references++,t[p].updater(h);else{var g=o(h,i);i.byIndex=r,t.splice(r,0,{identifier:d,updater:g,references:1})}s.push(d)}return s}function o(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,o){var a=i(e=e||[],o=o||{});return function(e){e=e||[];for(var s=0;s<a.length;s++){var r=n(a[s]);t[r].references--}for(var l=i(e,o),c=0;c<a.length;c++){var u=n(a[c]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}a=l}}},569:e=>{var t={};e.exports=function(e,n){var i=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(n)}},216:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},565:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},795:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var i="";n.supports&&(i+="@supports (".concat(n.supports,") {")),n.media&&(i+="@media ".concat(n.media," {"));var o=void 0!==n.layer;o&&(i+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),i+=n.css,o&&(i+="}"),n.media&&(i+="}"),n.supports&&(i+="}");var a=n.sourceMap;a&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(i,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},589:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},t={};function n(i){var o=t[i];if(void 0!==o)return o.exports;var a=t[i]={id:i,exports:{}};return e[i](a,a.exports,n),a.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0,(()=>{var e=n(379),t=n.n(e),i=n(795),o=n.n(i),a=n(569),s=n.n(a),r=n(565),l=n.n(r),c=n(216),u=n.n(c),d=n(589),p=n.n(d),h=n(768),g={};g.styleTagTransform=p(),g.setAttributes=l(),g.insert=s().bind(null,"head"),g.domAPI=o(),g.insertStyleElement=u();t()(h.Z,g);h.Z&&h.Z.locals&&h.Z.locals;function f(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class m{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};f(this,"_length",0),f(this,"_complete",0),f(this,"blocks",{}),this.hasHead=!1!==e.hasHead,this.hasHref=!1!==e.hasHref,Reflect.deleteProperty(e,"hasHead"),Reflect.deleteProperty(e,"hasHref");const t=e=>{const t=document.createElement("template");return t.innerHTML=e.trim(),t.content.children[0]};this.element=t('<div class="snake"></div>');for(const t in e)this.element.setAttribute(t,e[t]);this.hasHead&&(this.head=t('<div class="snake-head"></div>'),this.head.complete=t('<span class=""snake-head-complete">0</div>'),this.head.length=t('<span class=""snake-head-all">0</div>'),this.head.append("已完成：",this.head.complete,"/",this.head.length),this.element.append(this.head)),this.body=t('<div class="snake-body"></div>'),this.element.append(this.body)}set length(e){this._length=e,this.hasHead&&(this.head.length.innerHTML=e)}get length(){return this._length}set complete(e){this._complete=e,this.hasHead&&(this.head.complete.innerHTML=e)}get complete(){return this._complete}addScale(e,t,n){if(this.blocks[e])throw new Error("Snake: 项目".concat(e,"已存在。"));let i;this.hasHref?(i=document.createElement("a"),i.title=t||e,i.href=n||"/".concat(e),i.target="_blank"):(i=document.createElement("div"),t&&(i.title=t)),i.classList.add("snake-scale","scale-state-ready"),i.dataset.scaleState="ready",this.length++,this.blocks[e]=i,this.body.append(i)}removeScale(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(const e of t){if(!this.blocks[e])throw new Error("Snake: 不存在名为".concat(t,"的项目。"));this.blocks[e].remove(),this.length--,Reflect.deleteProperty(this.blocks,e)}}crawl(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success";if(!this.blocks[e])throw new Error("Snake: 不存在名为".concat(e,"的项目。"));"success"===this.blocks[e].dataset.scaleState&&this.complete--,"success"===t&&this.complete++,"ongoing"===this.blocks[e].dataset.scaleState&&this.blocks[e].classList.remove("oo-ui-pendingElement-pending"),"ongoing"===t&&this.blocks[e].classList.add("oo-ui-pendingElement-pending"),this.blocks[e].dataset.scaleState=t,this.blocks[e].scrollIntoView()}clear(){this.complete=0,this.length=0,this.blocks={},this.body.innerHTML=""}}var b=n(980),v={};v.styleTagTransform=p(),v.setAttributes=l(),v.insert=s().bind(null,"head"),v.domAPI=o(),v.insertStyleElement=u();t()(b.Z,v);b.Z&&b.Z.locals&&b.Z.locals;function y(){return y="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=w(e)););return e}(e,t);if(i){var o=Object.getOwnPropertyDescriptor(i,t);return o.get?o.get.call(arguments.length<3?e:n):o.value}},y.apply(this,arguments)}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function k(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}$((()=>(async e=>{if(mw.config.get("wgNamespaceNumber")<0&&mw.config.get("wgRelevantPageName")===mw.config.get("wgPageName"))return;await mw.loader.using(["mediawiki.api","mediawiki.user","mediawiki.notification","oojs-ui"]);const t=new mw.Api,n=-1===mw.config.get("wgNamespaceNumber")?mw.config.get("wgRelevantPageName"):mw.config.get("wgPageName"),i=(await mw.user.getRights()).includes("noratelimit");class o extends OO.ui.Dialog{constructor(){super(...arguments),k(this,"failList",[]),k(this,"changeList",[]),k(this,"complete",0),k(this,"progressBar",new m),k(this,"running",!1),k(this,"waitInterval",(e=>new Promise((t=>setTimeout(t,e))))),k(this,"getIncludeList",(async()=>{let e=1;const i=[];for(;e;){const o=await t.get({action:"query",prop:"transcludedin",titles:n,tilimit:"max",ticontinue:e});if(Object.values(o.query.pages)[0].transcludedin)for(const{title:e}of Object.values(o.query.pages)[0].transcludedin)i.push(e);e=!!o.continue&&o.continue.ticontinue}return i.length>0?mw.notify("获取嵌入【".concat(n,"】的页面列表成功。")):mw.notify("没有页面嵌入了【".concat(n,"】。")),i})),k(this,"getLinkList",(async()=>{let e=1;const i=[];for(;e;){var o;const a=await t.get({action:"query",prop:"linkshere",titles:n,lhlimit:"max",lhcontinue:e});if(Object.values(a.query.pages)[0].linkshere)for(const{title:e}of Object.values(a.query.pages)[0].linkshere)i.push(e);e=null===(o=a.continue)||void 0===o?void 0:o.lhcontinue}return i.length>0?mw.notify("获取链接到【".concat(n,"】的页面列表成功。")):mw.notify("没有页面链接到【".concat(n,"】。")),i}))}initialize(){super.initialize(),this.$header=$('<header class="okp-header"></header>'),this.panelLayout=new OO.ui.PanelLayout({scrollable:!1,expanded:!1,padded:!0}),this.$footer=$('<footer class="okp-footer"></footer>'),this.closeButton=new OO.ui.ButtonWidget({label:"取消",flags:["destructive"]}),this.stopButton=new OO.ui.ButtonWidget({label:"终止",flags:["primary","destructive"]}),this.stopButton.$element.hide(),this.actionButton=new OO.ui.ButtonWidget({label:"执行",flags:["primary","progressive"]}),this.typeSelectInput=new OO.ui.CheckboxMultiselectInputWidget({options:[{data:"link",label:"链接"},{data:"include",label:"嵌入"}]});const e=new OO.ui.FieldLayout(this.typeSelectInput,{label:"页面类型"}),t=new OO.ui.ButtonWidget({label:"帮助",icon:"help"}),o=new OO.ui.RadioOptionWidget({data:"purge",label:"清除缓存（Purge）"}),a=new OO.ui.RadioOptionWidget({data:"nulledit",label:"零编辑（Null Edit）"});this.optionRadioSelect=new OO.ui.RadioSelectWidget({items:[o,a]}),this.optionRadioSelect.selectItem(o);const s=new OO.ui.FieldLayout(this.optionRadioSelect,{label:"操作类型"}),r=i?"<b>提醒</b>：在被大量嵌入/链入的页面此工具将会向服务器发送<b>大量请求</b>，请慎重使用！":"<b>提醒</b>：您未持有<code>noratelimit</code>权限，清除缓存和零编辑的速率将被分别限制为<u>30次/min</u>和<u>10次/min</u>，请耐心等待。";this.closeButton.on("click",(()=>this.close())),this.stopButton.on("click",(()=>{this.stopButton.setDisabled(!0),this.running=!1})),t.on("click",(()=>{OO.ui.alert($('<ul id="one-key-purge-help"></ul>').append("<li><b>清除缓存</b>：通常在需要刷新页面内容时使用，例如模板编辑后刷新嵌入了此模板的页面。</li>",'<li><b>零编辑</b>：通常在需要刷新<a href="/Special:链入页面/'.concat(n,'">链入/嵌入页面列表</a>时使用，例如页面移动后清理链入。</li>')),{title:"帮助",size:"medium"})})),this.actionButton.on("click",(()=>this.action())),this.$body.append(this.$header.append($('<div class="okp-button okp-cancel-button"></div>').append(this.closeButton.$element,this.stopButton.$element),$('<div class="okp-header-text">批量清除页面缓存</div>'),$('<div class="okp-button okp-action-button"></div>').append(this.actionButton.$element)),this.panelLayout.$element.append('<div class="okp-note">'.concat(r,"</div>"),e.$element,s.$element,$(this.progressBar.element)),this.$footer.append($('<div class="okp-button okp-help-button"></div>').append(t.$element)))}async getList(){const e=[];try{if(this.typeSelectInput.getValue().includes("link")){const t=await this.getLinkList();e.push(...t)}if(this.typeSelectInput.getValue().includes("include")){const t=await this.getIncludeList();e.push(...t)}}catch(e){}return[...new Set(e)]}get optionType(){var e;return null===(e=this.optionRadioSelect.findSelectedItem())||void 0===e?void 0:e.getData()}progressChange(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const i="nulledit"===this.optionType?"零编辑":"清除缓存";switch(this.progressBar.crawl(e,t),t.toLowerCase()){case"success":this.complete++;break;case"warn":this.complete++,this.changeList.push(e);break;case"fail":this.failList.push(e),mw.notify("页面【".concat(e,"】").concat(i,"失败").concat(n?"：".concat(n):"","。"),{type:"warn"})}}async nullEdit(e){for(let n=0;n<e.length&&this.running;n++){const o=e[n];this.progressBar.crawl(o,"ongoing"),t.postWithToken("csrf",{format:"json",action:"edit",appendtext:"",watchlist:"nochange",nocreate:!0,title:o}).done((e=>{this.progressBar.crawl(o,"ongoing"),"Success"===e.edit.result?void 0!==e.edit.nochange?this.progressChange(o,"success"):this.progressChange(o,"warn"):this.progressChange(o,"fail")})).catch((e=>{this.progressChange(o,"fail",e)})),n+1<e.length&&(i?await this.waitInterval(1e3):await this.waitInterval(6e3))}}async purge(e){for(let n=0;n<e.length&&this.running;n+=5){const o=e.slice(n,n+5);for(const e of o)this.progressBar.crawl(e,"ongoing");t.post({format:"json",action:"purge",titles:o.join("|"),forcelinkupdate:!0}).done((e=>{for(const t of e.purge)this.progressChange(t.title,"success")})).catch((e=>{for(const t of o)this.progressChange(t,"fail",e)})),n+5<e.length&&(i?await this.waitInterval(1e3):await this.waitInterval(2e3))}}async action(){this.progressBar.clear(),0===this.typeSelectInput.getValue().length&&mw.notify("请选择页面类型。"),this.failList=[],this.changeList=[],this.complete=0,this.running=!0,this.$header.addClass("oo-ui-pendingElement-pending"),this.actionButton.setDisabled(!0),this.stopButton.setDisabled(!1),this.closeButton.$element.hide(),this.stopButton.$element.show();const e=await this.getList();e.length>0&&mw.notify("共".concat(e.length,"个页面，开始执行").concat("nulledit"===this.optionType?"零编辑":"清除缓存","……"));for(const t of e)this.progressBar.addScale(t);this.updateSize(),"nulledit"===this.optionType?await this.nullEdit(e):await this.purge(e),this.failList.length>0&&OO.ui.alert($("<div>".concat(this.failList.join("、"),"<br>可能页面受到保护，或编辑被过滤器拦截，请手动检查。</div>")),{title:"提示",size:"medium"}),this.changeList.length>0&&OO.ui.alert($("<div>".concat(this.changeList.join("、"),"。<br>被意外更改，请手动撤回或回退")),{title:"警告",size:"medium"}),this.$header.removeClass("oo-ui-pendingElement-pending"),this.actionButton.setDisabled(!1),this.closeButton.$element.show(),this.stopButton.$element.hide()}}k(o,"static",{...y(w(e=o),"static",e),tagName:"div",name:"one-key-purge"});const a=$("body"),s=new OO.ui.WindowManager({id:"one-key-purge"});a.append(s.$element);const r=new o({size:"large"});s.addWindows([r]),$(mw.util.addPortletLink("p-cactions","javascript:void(0)","批量清除缓存","ca-okp")).on("click",(()=>{$("#mw-notification-area").appendTo("body"),s.openWindow(r),a.css("overflow","auto")}))})()))})()})();